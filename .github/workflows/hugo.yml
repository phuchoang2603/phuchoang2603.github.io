name: Deploy Hugo Site (PRs & Main)

on:
  # 1. Run on pushes to main
  push:
    branches: ["main"]
  # 2. Run on pull requests targeting main
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

# Set permissions
permissions:
  contents: write # To push to gh-pages
  pull-requests: write # To comment on PRs

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    env:
      HUGO_CACHEDIR: /tmp/hugo_cache
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.151.0"
          extended: true

      # --- Dynamically set the BaseURL ---
      - name: Set up Base URL for PR
        if: github.event_name == 'pull_request'
        run: echo "BASE_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/previews/${{ github.event.pull_request.number }}/" >> $GITHUB_ENV

      - name: Set up Base URL for Main
        if: github.event_name == 'push'
        run: echo "BASE_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_ENV

      - name: Cache Hugo Modules
        uses: actions/cache@v4
        with:
          path: ${{ env.HUGO_CACHEDIR }}
          key: ${{ runner.os }}-hugomod-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-hugomod-

      - name: Build Hugo site
        run: hugo --minify --baseURL "${{ env.BASE_URL }}"

      # --- Deployment Logic ---

      - name: Deploy to Main (Root)
        # Only run this step if we are on the 'main' branch
        if: github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          destination_dir: . # Deploy to the root of the branch
          publish_branch: gh-pages
          keep_files: true # IMPORTANT: Do not delete the 'previews' folder

      - name: Deploy to PR (Preview)
        # Only run this step if it's a pull request
        if: github.event_name == 'pull_request'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          destination_dir: previews/${{ github.event.pull_request.number }}
          publish_branch: gh-pages
          # keep_files: false (default) is fine here, it will clean the preview folder

      - name: Add comment with preview link
        # Only run this step if it's a pull request
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ðŸš€ Pull Request Preview available at:
            ${{ env.BASE_URL }}
