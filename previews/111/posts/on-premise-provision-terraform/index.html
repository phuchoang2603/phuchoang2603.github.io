<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform &#183; /home/fel1x</title><meta name=title content="On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform &#183; /home/fel1x"><meta name=description content="A blog about my life, my projects and my thoughts"><meta name=keywords content="terraform,proxmox,kubernetes,cloud,"><link rel=canonical href=https://phuchoang2603.github.io/previews/111/posts/on-premise-provision-terraform/><meta name=author content="Felix Hoang"><link href=https://github.com/phuchoang2603 rel=me><link href=https://linkedin.com/in/phuchoang2603 rel=me><meta property="og:url" content="https://phuchoang2603.github.io/previews/111/posts/on-premise-provision-terraform/"><meta property="og:site_name" content="/home/fel1x"><meta property="og:title" content="On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform"><meta property="og:description" content="I’m the kind of person who will happily spend 10 hours building an automation script just to save 10 minutes of manual work every day. If that sounds like you, you’re in the right place."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-06T00:00:00+00:00"><meta property="article:modified_time" content="2025-11-06T00:00:00+00:00"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="Proxmox"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Cloud"><meta property="og:see_also" content="https://phuchoang2603.github.io/previews/111/posts/on-premise-storage/"><meta property="og:see_also" content="https://phuchoang2603.github.io/previews/111/posts/on-premise-hypervisor/"><meta property="og:see_also" content="https://phuchoang2603.github.io/previews/111/posts/on-premise-hardware/"><meta name=twitter:card content="summary"><meta name=twitter:title content="On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform"><meta name=twitter:description content="I’m the kind of person who will happily spend 10 hours building an automation script just to save 10 minutes of manual work every day. If that sounds like you, you’re in the right place."><meta name=google-site-verification content="ZN_K5PVRzd6d5xDuzqI-4N_QI1YUnMWqf7T8rlXMUzg"><link type=text/css rel=stylesheet href=/previews/111/css/main.bundle.min.2eafb51bdb78418e5b035d7c8ece02c448e0391ea702d3d87ae70f1941f3e98bfe534b478047cb61a3b44503c2094ac025de366efdf454ad0766e666165e8a93.css integrity="sha512-Lq+1G9t4QY5bA118js4CxEjgOR6nAtPYeucPGUHz6Yv+U0tHgEfLYaO0RQPCCUrAJd42bv30VK0HZuZmFl6Kkw=="><script type=text/javascript src=/previews/111/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script type=text/javascript src=/previews/111/js/zen-mode.min.9814dee9614d32aeb56239d118edfe20acd6231424f9b19c2dd48835038414130a5e946c0d1c9087d60e60e31840c9babfd217e3d4b95643dc8d651a71ccdf4a.js integrity="sha512-mBTe6WFNMq61YjnRGO3+IKzWIxQk+bGcLdSINQOEFBMKXpRsDRyQh9YOYOMYQMm6v9IX49S5VkPcjWUacczfSg=="></script><script src=/previews/111/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/previews/111/js/main.bundle.min.9cc802d09f28c6af56ceee7bc6e320a39251fdae98243f2a9942f221ac57a9f49c51609699a91794a7b2580ee1deaa8e4d794a68ffa94aa317c66e893ce51e02.js integrity="sha512-nMgC0J8oxq9Wzu57xuMgo5JR/a6YJD8qmULyIaxXqfScUWCWmakXlKeyWA7h3qqOTXlKaP+pSqMXxm6JPOUeAg==" data-copy=Copy data-copied=Copied></script><script src=/previews/111/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link type=text/css rel=stylesheet href=/previews/111/lib/lite-youtube-embed/lite-yt-embed.badabc6055b427669bbcf084097334cdf2029c85696c4a56e25239825d3571d26ef82b775ba19032ccd52135ccb412c9ba79da4e9e9b6f3939a6178a5f65ee5d.css integrity="sha512-utq8YFW0J2abvPCECXM0zfICnIVpbEpW4lI5gl01cdJu+Ct3W6GQMszVITXMtBLJunnaTp6bbzk5pheKX2XuXQ=="><script type=text/javascript src=/previews/111/lib/lite-youtube-embed/lite-yt-embed.58a8a22aed9d1cd05780869df4b0d87972fcd144a9eaff8f9a1453e58e6521c5a89ccd80bdb9f48e25ae5ee87b98bd9de51b14dd9988c60e4c89630433292084.js integrity="sha512-WKiiKu2dHNBXgIad9LDYeXL80USp6v+PmhRT5Y5lIcWonM2Avbn0jiWuXuh7mL2d5RsU3ZmIxg5MiWMEMykghA=="></script><link rel=stylesheet href=/previews/111/previews/111/posts/on-premise-provision-terraform/repo-cards.min.c128570dfd8dd9ad0c355ac610c78436df13e96bcad0d5aca61518f845d0f38071fcca66453bbceea416910be4c986e1bb2a4caec71f9a9f3f91b99b76727fb5.css integrity="sha512-wShXDf2N2a0MNVrGEMeENt8T6WvK0NWsphUY+EXQ84Bx/MpmRTu87qQWkQvkyYbhuypMrscfmp8/kbmbdnJ/tQ=="><link rel=apple-touch-icon sizes=180x180 href=/previews/111/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/previews/111/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/previews/111/favicon-16x16.png><link rel=manifest href=/previews/111/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform","headline":"On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform","abstract":"\u003cp\u003eI\u0026rsquo;m the kind of person who will happily spend 10 hours building an automation script just to save 10 minutes of manual work every day. If that sounds like you, you\u0026rsquo;re in the right place.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/phuchoang2603.github.io\/previews\/111\/posts\/on-premise-provision-terraform\/","author":{"@type":"Person","name":"Felix Hoang"},"copyrightYear":"2025","dateCreated":"2025-11-06T00:00:00\u002b00:00","datePublished":"2025-11-06T00:00:00\u002b00:00","dateModified":"2025-11-06T00:00:00\u002b00:00","keywords":["terraform","proxmox","kubernetes","cloud"],"mainEntityOfPage":"true","wordCount":"2969"}]</script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js></script><script>const firebaseConfig={apiKey:"AIzaSyCJUh8_eWSkkvDZwHdrPNBdyke7Dk422uI",authDomain:"phuchoang-sbs.firebaseapp.com",projectId:"phuchoang-sbs",storageBucket:"phuchoang-sbs.firebasestorage.app",messagingSenderId:"359041758586",appId:"1:359041758586:web:12cabd41bb64a6bda452c3",measurementId:"G-HVDVFDQDMC"};var app=firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth()</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom bg-neutral dark:bg-neutral-800"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/previews/111/ class="text-base font-medium">/home/fel1x</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/previews/111/posts/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/posts title=Posts><p class="text-base font-medium">/posts</p></a><a href=/previews/111/series/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=series title=Series><p class="text-base font-medium">series</p></a><a href=/previews/111/projects/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/projects title=Projects><p class="text-base font-medium">/projects</p></a><a href=/previews/111/tags/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=tags title=Tags><p class="text-base font-medium">tags</p></a><a href=/previews/111/about/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/about title="Welcome to my blog!"><p class="text-base font-medium">/about</p></a><a href=https://github.com/phuchoang2603 target=_blank class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=github title><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a href class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" title></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 me-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/previews/111/posts/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/posts title=Posts><p class="text-bg font-bg">/posts</p></a></li><li class=mt-1><a href=/previews/111/series/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=series title=Series><p class="text-bg font-bg">series</p></a></li><li class=mt-1><a href=/previews/111/projects/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/projects title=Projects><p class="text-bg font-bg">/projects</p></a></li><li class=mt-1><a href=/previews/111/tags/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=tags title=Tags><p class="text-bg font-bg">tags</p></a></li><li class=mt-1><a href=/previews/111/about/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/about title="Welcome to my blog!"><p class="text-bg font-bg">/about</p></a></li><li class=mt-1><a href=https://github.com/phuchoang2603 target=_blank class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=github title><div><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></div></a></li><li class=mt-1><a href class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" title></a></li></ul></div></div></div></div></div></div><script type=text/javascript src=/previews/111/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=/previews/111/image_13430388991849673189_hu_9f87f368a07f840e.png alt="On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform" loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script type=text/javascript src=/previews/111/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=background-blur data-image-id=background-image data-image-url=/previews/111/image_13430388991849673189_hu_9f87f368a07f840e.png></script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-11-06T00:00:00+00:00>6 November 2025</time><span class="px-2 text-primary-500">&#183;</span><span>2969 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">14 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/on-premise-provision-terraform.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span>
</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/on-premise-provision-terraform.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span>
</span><span class="px-2 text-primary-500">&#183;</span><span>
<button id=button_likes class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
<span id=button_likes_heart class="inline-block align-text-bottom hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span>
</span><span id=button_likes_emtpty_heart class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M244 84l11.1 12 12-11.98C300.6 51.37 347 36.51 392.6 44.1 461.5 55.58 512 115.2 512 185.1V190.9c0 41.5-17.2 81.2-47.6 109.5L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9S235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1.0 232.4.0 190.9V185.1c0-69.9 50.52-129.52 119.4-141 44.7-7.59 92 7.27 124.6 39.9C243.1 84 244 84.01 244 84zm11.1 79.9-45-46.8c-21.7-20.82-52.5-30.7-82.8-25.66C81.55 99.07 48 138.7 48 185.1V190.9c0 28.2 11.71 55.2 32.34 74.4L256 429.3l175.7-164c20.6-19.2 32.3-46.2 32.3-74.4V185.1c0-46.4-33.6-86.03-79.3-93.66C354.4 86.4 323.6 96.28 301.9 117.1l-46.8 46.8z"/></svg></span></span>
<span id=button_likes_text>&nbsp;Like</span>
</button>
</span><span class="px-2 text-primary-500">&#183;</span><span class=mb-[2px]>
<span id=zen-mode-button class="text-lg hover:text-primary-500" title="Enable zen mode" data-title-i18n-disable="Enable zen mode" data-title-i18n-enable="Disable zen mode"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentColor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/terraform/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Terraform
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/proxmox/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Proxmox
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/kubernetes/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/cloud/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cloud</span></span></a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#why-automate-the-case-for-iac-with-terraform>Why Automate? The Case for IaC with Terraform</a></li><li><a href=#my-terraform-blueprint-project-structure--principles>My Terraform Blueprint: Project Structure & Principles</a></li><li><a href=#connecting-to-proxmox-and-s3>Connecting to Proxmox and S3</a><ul><li><a href=#providertf-defining-our-connections><code>provider.tf</code>: Defining Our Connections</a></li><li><a href=#terraformtfstate-using-a-remote-backend><code>terraform.tfstate</code>: Using a Remote Backend</a></li><li><a href=#backendhcl-using-minio-for-remote-state><code>backend.hcl</code>: Using Minio for Remote State</a></li></ul></li><li><a href=#the-inputs-variables-tfvars-and-json> The &ldquo;Inputs&rdquo;: Variables, tfvars, and JSON</a><ul><li><a href=#variablestf-defining-the-api><code>variables.tf</code>: Defining the “API”</a></li><li><a href=#maintfvars-setting-environment-values><code>main.tfvars</code>: Setting Environment Values</a></li><li><a href=#k8s_nodesjson-a-dynamic-node-inventory><code>k8s_nodes.json</code>: A Dynamic Node Inventory</a></li></ul></li><li><a href=#the-blueprint-assembling-the-cluster>The &ldquo;Blueprint&rdquo;: Assembling the Cluster</a><ul><li><a href=#download_imgtf-acquiring-the-base-image><code>download_img.tf</code>: Acquiring the Base Image</a></li><li><a href=#create_user_configtf-preparing-cloud-init><code>create_user_config.tf</code>: Preparing Cloud-Init</a></li><li><a href=#modulesvm-the-reusable-vm-factory><code>modules/vm/</code>: The Reusable VM “Factory”</a></li><li><a href=#vmstf-orchestrating-the-build-with-for_each><code>vms.tf</code>: Orchestrating the Build with <code>for_each</code></a></li></ul></li><li><a href=#conclusion-the-12-hour-12-minute-payoff>Conclusion: The 12-Hour, 12-Minute Payoff</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#why-automate-the-case-for-iac-with-terraform>Why Automate? The Case for IaC with Terraform</a></li><li><a href=#my-terraform-blueprint-project-structure--principles>My Terraform Blueprint: Project Structure & Principles</a></li><li><a href=#connecting-to-proxmox-and-s3>Connecting to Proxmox and S3</a><ul><li><a href=#providertf-defining-our-connections><code>provider.tf</code>: Defining Our Connections</a></li><li><a href=#terraformtfstate-using-a-remote-backend><code>terraform.tfstate</code>: Using a Remote Backend</a></li><li><a href=#backendhcl-using-minio-for-remote-state><code>backend.hcl</code>: Using Minio for Remote State</a></li></ul></li><li><a href=#the-inputs-variables-tfvars-and-json> The &ldquo;Inputs&rdquo;: Variables, tfvars, and JSON</a><ul><li><a href=#variablestf-defining-the-api><code>variables.tf</code>: Defining the “API”</a></li><li><a href=#maintfvars-setting-environment-values><code>main.tfvars</code>: Setting Environment Values</a></li><li><a href=#k8s_nodesjson-a-dynamic-node-inventory><code>k8s_nodes.json</code>: A Dynamic Node Inventory</a></li></ul></li><li><a href=#the-blueprint-assembling-the-cluster>The &ldquo;Blueprint&rdquo;: Assembling the Cluster</a><ul><li><a href=#download_imgtf-acquiring-the-base-image><code>download_img.tf</code>: Acquiring the Base Image</a></li><li><a href=#create_user_configtf-preparing-cloud-init><code>create_user_config.tf</code>: Preparing Cloud-Init</a></li><li><a href=#modulesvm-the-reusable-vm-factory><code>modules/vm/</code>: The Reusable VM “Factory”</a></li><li><a href=#vmstf-orchestrating-the-build-with-for_each><code>vms.tf</code>: Orchestrating the Build with <code>for_each</code></a></li></ul></li><li><a href=#conclusion-the-12-hour-12-minute-payoff>Conclusion: The 12-Hour, 12-Minute Payoff</a></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!0,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><details class="mt-2 mb-5 overflow-hidden rounded-lg ms-0 ps-5" open><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 -ms-5 ps-5 dark:bg-primary-800 dark:text-neutral-100">On-Premise 101 -
This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/111/posts/on-premise-hardware/>Part 1:
On-Premise 101 (Part 1): Building a 3-Node Cluster</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/111/posts/on-premise-hypervisor/>Part 2:
On-Premise 101 (Part 2): Proxmox, the "Glue" for My Homelab</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/111/posts/on-premise-storage/>Part 3:
On-Premise 101 (Part 3): My "Fearless" NAS Build with Virtualized TrueNAS, ZFS, and Cloud Backups</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">Part 4:
This Article</div></details><div class="article-content max-w-prose mb-20"><p>I&rsquo;m the kind of person who will happily spend 10 hours building an automation script just to save 10 minutes of manual work every day. If that sounds like you, you&rsquo;re in the right place.</p><p>After covering the foundations of our hypervisor and storage platform, it&rsquo;s time to move on to the most interesting part of this series: provisioning a <code>Kubernetes</code> cluster on <code>Proxmox</code>. This means creating a bunch of VMs, and I refuse to do that manually. Luckily, I have learned <code>Terraform</code> and <code>Ansible</code> somewhat enough to be able to create this project below to automate it all.</p><div class=github-card-wrapper><a id=github-2bc5d1c24a42a21a5c2c265bfc49e4c9 target=_blank href=https://github.com/phuchoang2603/kubernetes-proxmox class=cursor-pointer><div class="w-full md:w-auto p-0 m-0 border border-neutral-200 dark:border-neutral-700 border rounded-md shadow-2xl"><div class="w-full nozoom"><img src=https://opengraph.githubassets.com/0/phuchoang2603/kubernetes-proxmox alt="GitHub Repository Thumbnail" class="nozoom mt-0 mb-0 w-full h-full object-cover"></div><div class="w-full md:w-auto pt-3 p-5"><div class="flex items-center"><span class="text-2xl text-neutral-800 dark:text-neutral me-2"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><div id=github-2bc5d1c24a42a21a5c2c265bfc49e4c9-full_name class="m-0 font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral">phuchoang2603/kubernetes-proxmox</div></div><p id=github-2bc5d1c24a42a21a5c2c265bfc49e4c9-description class="m-0 mt-2 text-md text-neutral-800 dark:text-neutral">auto provision and deploy k8s to proxmox using terraform + ansible</p><div class="m-0 mt-2 flex items-center"><span class="mr-1 inline-block h-3 w-3 rounded-full language-dot" data-language=Jinja></span><div class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">Jinja</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></span><div id=github-2bc5d1c24a42a21a5c2c265bfc49e4c9-stargazers class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">7</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M80 104c13.3.0 24-10.7 24-24S93.3 56 80 56 56 66.7 56 80s10.7 24 24 24zm80-24c0 32.8-19.7 61-48 73.3V192c0 17.7 14.3 32 32 32H304c17.7.0 32-14.3 32-32V153.3C307.7 141 288 112.8 288 80c0-44.2 35.8-80 80-80s80 35.8 80 80c0 32.8-19.7 61-48 73.3V192c0 53-43 96-96 96H256v70.7c28.3 12.3 48 40.5 48 73.3.0 44.2-35.8 80-80 80s-80-35.8-80-80c0-32.8 19.7-61 48-73.3V288H144c-53 0-96-43-96-96V153.3C19.7 141 0 112.8.0 80 0 35.8 35.8.0 80 0s80 35.8 80 80zm208 24c13.3.0 24-10.7 24-24s-10.7-24-24-24-24 10.7-24 24 10.7 24 24 24zM248 432c0-13.3-10.7-24-24-24s-24 10.7-24 24 10.7 24 24 24 24-10.7 24-24z"/></svg></span></span><div id=github-2bc5d1c24a42a21a5c2c265bfc49e4c9-forks class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">0</div></div></div></div><script async type=text/javascript src=/previews/111/js/fetch-repo.min.dc5533c50cefd50405344b235937142271f26229fe39cbee27fd4960e8bb897a0beebfad77a1091ca91cd0d1fb14e70fc37cc114dd9674fb2c32e0ab512ec8a4.js integrity="sha512-3FUzxQzv1QQFNEsjWTcUInHyYin+OcvuJ/1JYOi7iXoL7r+td6EJHKkc0NH7FOcPw3zBFN2WdPssMuCrUS7IpA==" data-repo-url=https://api.github.com/repos/phuchoang2603/kubernetes-proxmox data-repo-id=github-2bc5d1c24a42a21a5c2c265bfc49e4c9></script></a></div><p>This post is first part of my deep dive on the project, focusing on how I use <code>Terraform</code> to create a repeatable, automated, and scalable VMs cluster on Proxmox, all with a single command. If you want to see how this project performs in action, you can watch the video below.</p><lite-youtube videoid=IrlKAG5bctk playlabel=IrlKAG5bctk params></lite-youtube><h2 class="relative group">Why Automate? The Case for IaC with Terraform<div id=why-automate-the-case-for-iac-with-terraform class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#why-automate-the-case-for-iac-with-terraform aria-label=Anchor>#</a></span></h2><p>&ldquo;But what is <code>Terraform</code>?&rdquo; you might ask. Again, we need to consider the core problem it solves to truly appreciate it.</p><p>Before <code>Terraform</code>, and before the &ldquo;cloud&rdquo; even existed, people deployed infrastructure by manually creating VMs with repeated configurations (CPU, RAM, network, firewall) and then SSH into each machine to run commands,or if they were fancy, a bash script. This did the job, but doing it manually was error-prone, time-consuming, and a nightmare to document.</p><p>The &ldquo;cloud&rdquo; was born to help solve this: it&rsquo;s still someone&rsquo;s computer, but those computers are now abstracted with many services on top, so we no longer need to build the infrastructure ourselves and can create VMs faster. Heck, we might not need to create VMs; instead, we just need to write a Dockerfile, or even just the function of the code, to get it deployed directly. However, we still often need to manually log in to a website and create VMs through a clunky UI.</p><p>That&rsquo;s where <code>Terraform</code> comes in. It&rsquo;s an open-source, <strong>Infrastructure as Code (IaC)</strong> tool from <code>HashiCorp</code> that lets you define and provision infrastructure using a declarative configuration language called <code>HCL</code>. It allows you to build, change, and manage infrastructure safely and efficiently. By writing code to describe your desired end state, <code>Terraform</code> automates the process of creating, updating, and destroying infrastructure, reducing manual effort and improving consistency.</p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/hJ52zRfm/image.png></figure><p>Because your infrastructure is now <em>code</em>, it inherits awesome features like version history (via Git) and a documented process. If something goes wrong, you can tear down and bring up the entire infrastructure again with just two commands: <code>terraform destroy</code> and <code>terraform apply</code>. If someone new joins the team, they can easily get a grasp of the infrastructure by reading the code, without endless clicking on a cloud provider&rsquo;s website.</p><p>By using <code>Terraform</code>, I can easily create tons of VMs on <code>Proxmox</code> and show you exactly what I&rsquo;m doing.</p><h2 class="relative group">My Terraform Blueprint: Project Structure & Principles<div id=my-terraform-blueprint-project-structure--principles class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#my-terraform-blueprint-project-structure--principles aria-label=Anchor>#</a></span></h2><p>In the image above, we see 4 files on the left. These also represent the 4 primary components of a <code>Terraform</code> project: <strong>providers</strong>, <strong>variables</strong>, <strong>state</strong>, and <strong>instances</strong> (resources/modules).</p><p>Before diving into each component, let&rsquo;s establish the core design principles that keep our <code>Terraform</code> code from becoming a messy nightmare (otherwise, it&rsquo;s no better than the clunky UI):</p><ol><li><strong>Separation of Concerns</strong>: Each file should has a distinct and clear purpose.</li><li><strong>Variable-Driven Configuration</strong>: The infrastructure&rsquo;s composition (how many nodes, their IPs, etc.) is defined in variables file, not hardcoded in the logic.</li><li><strong>Modularity</strong>: Reusable components (like a virtual machine) are encapsulated in modules.</li><li><strong>Environment Isolation</strong>: Configurations for different environments (like dev and prod) are kept separate.</li></ol><p>To give you a map of what I&rsquo;m doing, here&rsquo;s my <code>Terraform</code> file structure:</p><pre tabindex=0><code>.
├── create_user_config.tf
├── download_img.tf
├── env
│   ├── dev
│   │   ├── backend.hcl
│   │   ├── k8s_nodes.json
│   │   ├── longhorn_nodes.json
│   │   └── main.tfvars
│   └── prod
│       ├── backend.hcl
│       ├── k8s_nodes.json
│       ├── longhorn_nodes.json
│       └── main.tfvars
├── modules
│   └── vm
│       ├── main.tf
│       ├── outputs.tf
│       └── variables.tf
├── provider.tf
├── variables.tf
└── vms.tf
</code></pre><h2 class="relative group">Connecting to Proxmox and S3<div id=connecting-to-proxmox-and-s3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#connecting-to-proxmox-and-s3 aria-label=Anchor>#</a></span></h2><h3 class="relative group"><code>provider.tf</code>: Defining Our Connections<div id=providertf-defining-our-connections class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#providertf-defining-our-connections aria-label=Anchor>#</a></span></h3><p>Providers are plugins that enable <code>Terraform</code> to interact with various platforms (AWS, Azure, GCP) and services (Kubernetes, DNS, etc.). They understand the resource types and make the API calls to create, read, update, and delete them.</p><p>In my case, I need to spin up VMs on <code>Proxmox</code>, so I looked for a provider that integrates with it. There are two prominent ones: <a href=https://github.com/Telmate/terraform-provider-proxmox target=_blank><code>Telmate/terraform-provider-proxmox</code></a> and <a href=https://github.com/bpg/terraform-provider-proxmox target=_blank><code>bpg/terraform-provider-proxmox</code></a>. The one from <code>telmate</code> has been around for a long time but is limited in functionality. The one from <code>bpg</code> is newer and allows you to manage <em>every</em> aspect of a <code>Proxmox</code> environment. Thus, I opted for <code>bpg</code>.</p><p>Later, I&rsquo;ll introduce the concept of &ldquo;remote state,&rdquo; which uses a backend provider. I&rsquo;ll be using an S3-compatible object storage (Minio), so I&rsquo;ll define that as well. Enough talk, here&rsquo;s my <code>provider.tf</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>terraform</span> {
</span></span><span class=line><span class=cl><span class=n>  required_version</span> <span class=o>=</span><span class=n> &#34;&gt;</span><span class=o>=</span> <span class=m>1</span><span class=p>.</span><span class=m>6</span><span class=p>.</span><span class=m>6</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>required_providers</span> {
</span></span><span class=line><span class=cl><span class=n>    `Proxmox`</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      source</span>  <span class=o>=</span> <span class=s2>&#34;bpg/proxmox&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      version</span> <span class=o>=</span> <span class=s2>&#34;0.77.1&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>  <span class=k>backend</span> <span class=s2>&#34;s3&#34;</span> {}
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>provider</span> <span class=s2>&#34;proxmox&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  endpoint</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>proxmox_endpoint</span>
</span></span><span class=line><span class=cl><span class=n>  insecure</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>proxmox_insecure</span>
</span></span><span class=line><span class=cl><span class=n>  min_tls</span>  <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>proxmox_min_tls</span>
</span></span><span class=line><span class=cl><span class=n>  username</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>proxmox_username</span>
</span></span><span class=line><span class=cl><span class=n>  password</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>proxmox_password</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Notice the <code>version</code> constraint - this is a critical best practice that locks your project to a specific provider version, preventing unexpected breaking changes from automatic updates.</p><h3 class="relative group"><code>terraform.tfstate</code>: Using a Remote Backend<div id=terraformtfstate-using-a-remote-backend class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#terraformtfstate-using-a-remote-backend aria-label=Anchor>#</a></span></h3><p>Terraform state is a crucial component that stores a mapping of your configured resources to the real-world objects that have been created. It’s how <code>Terraform</code> knows what it manages.</p><p>There are two primary ways to store state: <strong>local</strong> (a <code>terraform.tfstate</code> file on your computer) and <strong>remote</strong> (on an online storage service like S3). The local state is fine for solo experiments but is disastrous for teams where multiple people are trying to make changes. What happens is <code>Terraform</code> can&rsquo;t match the desired state (your code) with the <em>actual</em> state (on the server) because there&rsquo;s no single source of truth.</p><p>Therefore, I decided to use a <strong>remote backend</strong>. The credentials for it are handled by the <code>env/dev/backend.hcl</code> file below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=n>access_key</span>                  <span class=o>=</span> <span class=s2>&#34;terraform&#34;</span>
</span></span><span class=line><span class=cl><span class=n>secret_key</span>                  <span class=o>=</span> <span class=s2>&#34;QmwRghG9X80kC%&#34;</span>
</span></span><span class=line><span class=cl><span class=n>bucket</span>                      <span class=o>=</span> <span class=s2>&#34;terraform&#34;</span>
</span></span><span class=line><span class=cl><span class=n>key</span>                         <span class=o>=</span> <span class=s2>&#34;dev.tfstate&#34;</span>
</span></span><span class=line><span class=cl><span class=n>region</span>                      <span class=o>=</span> <span class=s2>&#34;us-east-1&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># --- MinIO Specific Settings ---
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># The URL of your MinIO server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>endpoints</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>  s3</span> <span class=o>=</span> <span class=s2>&#34;http://10.69.1.102:9000&#34;</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Use path-style addressing (e.g., http://minio/bucket/key)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>use_path_style</span> <span class=o>=</span> <span class=kt>true</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Skip AWS-specific validation checks
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>skip_credentials_validation</span> <span class=o>=</span> <span class=kt>true</span><span class=c1>  # Skip AWS related checks and validations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>skip_requesting_account_id</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>skip_metadata_api_check</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>skip_region_validation</span> <span class=o>=</span> <span class=kt>true</span>
</span></span></code></pre></div><p>What&rsquo;s more, using remote state, I can now use my <code>Terraform</code> code for multiple backends. I just need to keep my two backends (<code>dev</code> and <code>prod</code>) separate and I can decide which environment to initialize <code>Terraform</code> with by running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init -reconfigure -backend-config<span class=o>=</span>env/dev/backend.hcl
</span></span><span class=line><span class=cl><span class=c1># For production:</span>
</span></span><span class=line><span class=cl><span class=c1># terraform init -reconfigure -backend-config=env/prod/backend.hcl</span>
</span></span></code></pre></div><p>This keeps your core configuration clean and environment-agnostic. It securely stores your state in a remote, centralized location, enabling collaboration and preventing state file loss.</p><h3 class="relative group"><code>backend.hcl</code>: Using Minio for Remote State<div id=backendhcl-using-minio-for-remote-state class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#backendhcl-using-minio-for-remote-state aria-label=Anchor>#</a></span></h3><p>To get the credentials for the <code>backend.hcl</code> file, you first need to install <code>Minio</code> on your storage platform (in my case, <code>TrueNAS</code>).<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/vvjBCS2p/image.png></figure>You may also need to install <code>minio-console</code>. This is because we need to create an IAM user for <code>terraform</code> and get its credentials, and the primary <code>minio</code> container UI has removed some of those features. The <code>minio-console</code> brings those features back.<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/Wv9GvbMN/image.png></figure></p><h2 class="relative group"> The &ldquo;Inputs&rdquo;: Variables, tfvars, and JSON<div id=the-inputs-variables-tfvars-and-json class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-inputs-variables-tfvars-and-json aria-label=Anchor>#</a></span></h2><p>Next up are variables, which are the parameters for your <code>Terraform</code> configuration. They allow you to create flexible and reusable code by separating the &ldquo;what&rdquo; (the resource logic) from the &ldquo;how&rdquo; (the specific values).</p><h3 class="relative group"><code>variables.tf</code>: Defining the &ldquo;API&rdquo;<div id=variablestf-defining-the-api class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#variablestf-defining-the-api aria-label=Anchor>#</a></span></h3><p>This file acts as the &ldquo;API&rdquo; for the entire project. It defines every possible input, from provider credentials to VM specs, and sets optional default values. This file makes the project self-documenting.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;env&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Environment name (e.g., dev, prod)&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;proxmox_endpoint&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Proxmox API endpoint (e.g., https://your-proxmox-ip:8006)&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;proxmox_insecure&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>bool</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Skip TLS verification&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  default</span>     <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;proxmox_min_tls&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Minimum TLS version&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  default</span>     <span class=o>=</span> <span class=s2>&#34;1.3&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;proxmox_username&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Proxmox username&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;proxmox_password&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Proxmox password&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl><span class=n>  sensitive</span>   <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;proxmox_ssh_public_key&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;SSH public key for VM access&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;vm_node_name&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Proxmox node where VMs are created&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;vm_datastore_id&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Proxmox datastore ID where snippets cloud img are stored&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;vm_bridge&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Network bridge used for VM network&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;vm_timezone&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Timezone for the VM&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;vm_username&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Username for the VM template&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;vm_ip_gateway&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Gateway for Kubernetes VMs&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;dns_server&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;DNS server for Kubernetes VMs&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;k8s_cpu_cores&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Number of CPU cores per VM&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>number</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;k8s_cpu_type&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;CPU type for VM&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;k8s_memory_mb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Memory size in MB per VM&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>number</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;k8s_datastore_id&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;k8s datastore ID where VM disks are stored&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;k8s_disk_size_gb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Disk size in GB for VM disk&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>number</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;longhorn_cpu_cores&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Number of CPU cores per VM&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>number</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;longhorn_cpu_type&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;CPU type for VM&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;longhorn_memory_mb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Memory size in MB per VM&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>number</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;longhorn_datastore_id&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;longhorn datastore ID where VM disks are stored&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=k>variable</span> <span class=s2>&#34;longhorn_disk_size_gb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Disk size in GB for VM disk&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=k>number</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>locals</span> {
</span></span><span class=line><span class=cl><span class=n>  k8s_nodes</span>      <span class=o>=</span> <span class=k>jsondecode</span><span class=p>(</span><span class=k>file</span><span class=p>(</span><span class=s2>&#34;${path.root}/env/${var.env}/k8s_nodes.json&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>  longhorn_nodes</span> <span class=o>=</span> <span class=k>jsondecode</span><span class=p>(</span><span class=k>file</span><span class=p>(</span><span class=s2>&#34;${path.root}/env/${var.env}/longhorn_nodes.json&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h3 class="relative group"><code>main.tfvars</code>: Setting Environment Values<div id=maintfvars-setting-environment-values class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#maintfvars-setting-environment-values aria-label=Anchor>#</a></span></h3><p>While <code>variables.tf</code> <em>defines</em> the inputs, this file provides the <em>concrete values</em> for a specific environment. The reason I separate my <code>*.tfvars</code> files into <code>env/dev/</code> and <code>env/prod/</code> is the same as for the backend state: it allows me to spin up a completely new environment just by creating a new directory. You can tell <code>Terraform</code> which one to use like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply -var-file<span class=o>=</span><span class=s2>&#34;env/dev/main.tfvars&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># For production:</span>
</span></span><span class=line><span class=cl><span class=c1># terraform apply -var-file=&#34;env/prod/main.tfvars&#34;</span>
</span></span></code></pre></div><p>Here&rsquo;s an example of <code>env/dev/main.tfvars</code>. The variable names here must <em>exactly</em> match the names in <code>variables.tf</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Environment name
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>env</span> <span class=o>=</span> <span class=s2>&#34;dev&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># `Proxmox` API details - PLEASE FILL THESE IN
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>proxmox_endpoint</span>       <span class=o>=</span> <span class=s2>&#34;https://10.69.1.1:8006/&#34;</span>
</span></span><span class=line><span class=cl><span class=n>proxmox_username</span>       <span class=o>=</span> <span class=s2>&#34;root@pam&#34;</span>
</span></span><span class=line><span class=cl><span class=n>proxmox_password</span>       <span class=o>=</span> <span class=s2>&#34;Phuc@2006&#34;</span>
</span></span><span class=line><span class=cl><span class=n>proxmox_ssh_public_key</span> <span class=o>=</span> <span class=s2>&#34;/home/felix/.ssh/id_ed25519.pub&#34;</span><span class=c1> # Absolute path of your ssh public key on your machine
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># General VM settings - PLEASE REVIEW AND ADJUST
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>vm_node_name</span>    <span class=o>=</span> <span class=s2>&#34;pve&#34;</span><span class=c1>     # `Proxmox` node where VMs are created
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>vm_datastore_id</span> <span class=o>=</span> <span class=s2>&#34;truenas&#34;</span><span class=c1> # storage for downloading cloud img, storing snippets, etc.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>vm_bridge</span>       <span class=o>=</span> <span class=s2>&#34;vmbr0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>vm_timezone</span>     <span class=o>=</span> <span class=s2>&#34;America/New_York&#34;</span>
</span></span><span class=line><span class=cl><span class=n>vm_username</span>     <span class=o>=</span> <span class=s2>&#34;ubuntu&#34;</span>
</span></span><span class=line><span class=cl><span class=n>vm_ip_gateway</span>   <span class=o>=</span> <span class=s2>&#34;10.69.0.1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>dns_server</span>      <span class=o>=</span> <span class=s2>&#34;1.1.1.1&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># k8s cluster settings
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>k8s_cpu_cores</span>    <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=n>k8s_cpu_type</span>     <span class=o>=</span> <span class=s2>&#34;x86-64-v2-AES&#34;</span>
</span></span><span class=line><span class=cl><span class=n>k8s_memory_mb</span>    <span class=o>=</span> <span class=m>4096</span>
</span></span><span class=line><span class=cl><span class=n>k8s_disk_size_gb</span> <span class=o>=</span> <span class=m>64</span>
</span></span><span class=line><span class=cl><span class=n>k8s_datastore_id</span> <span class=o>=</span> <span class=s2>&#34;local-lvm&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># longhorn cluster settings
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>longhorn_cpu_cores</span>    <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=n>longhorn_cpu_type</span>     <span class=o>=</span> <span class=s2>&#34;x86-64-v2-AES&#34;</span>
</span></span><span class=line><span class=cl><span class=n>longhorn_memory_mb</span>    <span class=o>=</span> <span class=m>2048</span>
</span></span><span class=line><span class=cl><span class=n>longhorn_disk_size_gb</span> <span class=o>=</span> <span class=m>300</span>
</span></span><span class=line><span class=cl><span class=n>longhorn_datastore_id</span> <span class=o>=</span> <span class=s2>&#34;local-lvm&#34;</span>
</span></span></code></pre></div><h3 class="relative group"><code>k8s_nodes.json</code>: A Dynamic Node Inventory<div id=k8s_nodesjson-a-dynamic-node-inventory class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#k8s_nodesjson-a-dynamic-node-inventory aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>locals</span> {
</span></span><span class=line><span class=cl><span class=n>  k8s_nodes</span>      <span class=o>=</span> <span class=k>jsondecode</span><span class=p>(</span><span class=k>file</span><span class=p>(</span><span class=s2>&#34;${path.root}/env/${var.env}/k8s_nodes.json&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>  longhorn_nodes</span> <span class=o>=</span> <span class=k>jsondecode</span><span class=p>(</span><span class=k>file</span><span class=p>(</span><span class=s2>&#34;${path.root}/env/${var.env}/longhorn_nodes.json&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>You might have noticed the <code>locals</code> block at the end of <code>variables.tf</code>. This block dynamically loads the correct node inventory based on the <code>env</code> variable and makes it available to the rest of your configuration files. For example, it will read <code>env/dev/k8s_nodes.json</code>, which is the source of truth for my Kubernetes nodes. It defines each node’s name, ID, and IP address. To scale the cluster, you simply add a new entry to it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dev-server1&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;vm_id&#34;</span><span class=p>:</span> <span class=mi>111</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;node&#34;</span><span class=p>:</span> <span class=s2>&#34;pve&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;servers&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.69.1.111/16&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dev-server2&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;vm_id&#34;</span><span class=p>:</span> <span class=mi>112</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;node&#34;</span><span class=p>:</span> <span class=s2>&#34;pve2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;servers&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.69.1.112/16&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dev-server3&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;vm_id&#34;</span><span class=p>:</span> <span class=mi>113</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;node&#34;</span><span class=p>:</span> <span class=s2>&#34;pve3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;servers&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.69.1.113/16&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Not only does this make it easy to define multiple nodes, but it also helps Ansible (in the next part) read this same file to configure the IPs.</p><h2 class="relative group">The &ldquo;Blueprint&rdquo;: Assembling the Cluster<div id=the-blueprint-assembling-the-cluster class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-blueprint-assembling-the-cluster aria-label=Anchor>#</a></span></h2><p>Now that we have our variables configured, <code>Terraform</code> can talk to our infrastructure. The next step is to define <em>what to say</em>.</p><p>These are the <code>.tf</code> files that contain the logic - the blueprint for your infrastructure. They define resources, call modules, and orchestrate the entire deployment.</p><h3 class="relative group"><code>download_img.tf</code>: Acquiring the Base Image<div id=download_imgtf-acquiring-the-base-image class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#download_imgtf-acquiring-the-base-image aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;proxmox_virtual_environment_download_file&#34; &#34;ubuntu_cloud_image&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  content_type</span> <span class=o>=</span> <span class=s2>&#34;iso&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  datastore_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_datastore_id</span>
</span></span><span class=line><span class=cl><span class=n>  node_name</span>    <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_node_name</span>
</span></span><span class=line><span class=cl><span class=n>  file_name</span>    <span class=o>=</span> <span class=s2>&#34;${var.env}-noble-server-cloudimg-amd64.img&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  url</span> <span class=o>=</span> <span class=s2>&#34;https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This file has one job: download the Ubuntu cloud image from the internet and store it in Proxmox. The <code>proxmox_virtual_environment_download_file</code> resource from the <code>bpg/proxmox</code> provider handles this, ensuring the base image is available before any VMs are created. Its output ID is used later to specify the base disk for the VMs installation.</p><p>This ISO file is special because you can modify the VM configuration directly with the cloud-init bundle with it.</p><p>Result:<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/tp4YbxRH/image.png></figure></p><h3 class="relative group"><code>create_user_config.tf</code>: Preparing Cloud-Init<div id=create_user_configtf-preparing-cloud-init class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#create_user_configtf-preparing-cloud-init aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>data</span> <span class=s2>&#34;local_file&#34; &#34;ssh_public_key&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  filename</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>proxmox_ssh_public_key</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;proxmox_virtual_environment_file&#34; &#34;user_data_cloud_config&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  content_type</span> <span class=o>=</span> <span class=s2>&#34;snippets&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  datastore_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_datastore_id</span>
</span></span><span class=line><span class=cl><span class=n>  node_name</span>    <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_node_name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>source_raw</span> {
</span></span><span class=line><span class=cl><span class=n>    data</span> <span class=o>=</span> <span class=err>&lt;&lt;-</span><span class=k>EOF</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    #cloud-config
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>host</span><span class=err>-</span><span class=k>name</span><span class=err>:</span> <span class=k>ubuntu_cloud_image</span>
</span></span><span class=line><span class=cl>    <span class=k>timezone</span><span class=err>:</span> <span class=si>${</span><span class=err>var</span><span class=p>.</span><span class=err>vm_timezone</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    <span class=k>users</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=err>-</span> <span class=k>default</span>
</span></span><span class=line><span class=cl>      <span class=err>-</span> <span class=k>name</span><span class=err>:</span> <span class=si>${</span><span class=err>var</span><span class=p>.</span><span class=err>vm_username</span><span class=si>}</span>
</span></span><span class=line><span class=cl>        <span class=k>groups</span><span class=err>:</span>
</span></span><span class=line><span class=cl>          <span class=err>-</span> <span class=k>sudo</span>
</span></span><span class=line><span class=cl>        <span class=k>shell</span><span class=err>:</span> <span class=err>/</span><span class=k>bin</span><span class=err>/</span><span class=k>bash</span>
</span></span><span class=line><span class=cl>        <span class=k>ssh_authorized_keys</span><span class=err>:</span>
</span></span><span class=line><span class=cl>          <span class=err>-</span> <span class=si>${</span><span class=err>trimspace</span><span class=p>(</span><span class=err>data</span><span class=p>.</span><span class=err>local_file</span><span class=p>.</span><span class=err>ssh_public_key</span><span class=p>.</span><span class=err>content</span><span class=p>)</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=n>        sudo: ALL</span><span class=o>=</span><span class=p>(</span><span class=k>ALL</span><span class=p>)</span> <span class=k>NOPASSWD</span><span class=err>:</span><span class=k>ALL</span>
</span></span><span class=line><span class=cl>    <span class=k>package_update</span><span class=err>:</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>    <span class=k>packages</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=err>-</span> <span class=k>qemu</span><span class=err>-</span><span class=k>guest</span><span class=err>-</span><span class=k>agent</span>
</span></span><span class=line><span class=cl>      <span class=err>-</span> <span class=k>net</span><span class=err>-</span><span class=k>tools</span>
</span></span><span class=line><span class=cl>      <span class=err>-</span> <span class=k>curl</span>
</span></span><span class=line><span class=cl>      <span class=err>-</span> <span class=k>cryptsetup</span>
</span></span><span class=line><span class=cl>    <span class=k>runcmd</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=err>-</span> <span class=k>systemctl</span> <span class=k>start</span> <span class=k>qemu</span><span class=err>-</span><span class=k>guest</span><span class=err>-</span><span class=k>agent</span>
</span></span><span class=line><span class=cl>    <span class=k>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>    file_name</span> <span class=o>=</span> <span class=s2>&#34;user-data-cloud-config.yaml&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;proxmox_virtual_environment_file&#34; &#34;meta_data_cloud_config&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  for_each</span>     <span class=o>=</span> <span class=k>merge</span><span class=p>(</span><span class=k>local</span><span class=p>.</span><span class=k>k8s_nodes</span><span class=p>,</span> <span class=k>local</span><span class=p>.</span><span class=k>longhorn_nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>  content_type</span> <span class=o>=</span> <span class=s2>&#34;snippets&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  datastore_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_datastore_id</span>
</span></span><span class=line><span class=cl><span class=n>  node_name</span>    <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_node_name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>source_raw</span> {
</span></span><span class=line><span class=cl><span class=n>    data</span> <span class=o>=</span> <span class=err>&lt;&lt;-</span><span class=k>EOF</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    #cloud-config
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>local</span><span class=err>-</span><span class=k>hostname</span><span class=err>:</span> <span class=si>${</span><span class=err>each</span><span class=p>.</span><span class=err>key</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    <span class=k>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>    file_name</span> <span class=o>=</span> <span class=s2>&#34;${each.key}-meta-data-cloud-config.yaml&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This is one of the most important files for automation. It creates the configuration “snippets” that <code>cloud-init</code> will use to configure the VMs on their first boot.</p><ol><li><strong><code>user_data_cloud_config</code></strong>: This is a generic configuration applied to <em>all</em> VMs. It sets the timezone, creates a default user (<code>ubuntu</code>), injects your SSH public key for passwordless access, and installs essential packages like <code>qemu-guest-agent</code>.</li><li><strong><code>meta_data_cloud_config</code></strong>: This creates a <em>specific</em> metadata file for <em>each</em> VM. It iterates through the node maps loaded in <code>locals.tf</code> and creates a snippet that sets the correct hostname for each machine (e.g., <code>dev-server1</code>).</li></ol><p>Result:<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/m5w4LghJ/image.png></figure></p><h3 class="relative group"><code>modules/vm/</code>: The Reusable VM &ldquo;Factory&rdquo;<div id=modulesvm-the-reusable-vm-factory class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#modulesvm-the-reusable-vm-factory aria-label=Anchor>#</a></span></h3><p>This directory encapsulates all the logic for creating a <em>single</em> <code>Proxmox</code> VM. It&rsquo;s a <code>Terraform</code> <code>module</code>—a reusable package of configuration, much like a &ldquo;class&rdquo; in object-oriented programming.</p><ul><li><strong><code>variables.tf</code></strong>: This is the “order form” for the factory. It defines all the parameters needed to create one VM, such as its name, CPU cores, memory, IP address, etc.</li><li><strong><code>main.tf</code></strong>: This is the “assembly line.” It contains the <code>proxmox_virtual_environment_vm</code> resource block. It takes all the variables and uses them to configure the VM’s properties, from its CPU and memory to its disk and network settings.</li><li><strong><code>outputs.tf</code></strong>: This defines the “shipping label,” outputting the final <code>vm_id</code> of the created machine.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># main.tf
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>terraform</span> {
</span></span><span class=line><span class=cl>  <span class=k>required_providers</span> {
</span></span><span class=line><span class=cl><span class=n>    `Proxmox`</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      source</span>  <span class=o>=</span> <span class=s2>&#34;bpg/proxmox&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      version</span> <span class=o>=</span> <span class=s2>&#34;0.77.1&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;proxmox_virtual_environment_vm&#34; &#34;vm&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>  node_name</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>node_name</span>
</span></span><span class=line><span class=cl><span class=n>  vm_id</span>     <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>agent</span> {
</span></span><span class=line><span class=cl><span class=n>    enabled</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  stop_on_destroy</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  machine</span>         <span class=o>=</span> <span class=s2>&#34;q35&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  bios</span>            <span class=o>=</span> <span class=s2>&#34;ovmf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span>     <span class=o>=</span> <span class=s2>&#34;Cloud-Init ready Kubernetes template managed by Terraform&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>cpu</span> {
</span></span><span class=line><span class=cl><span class=n>    cores</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>cpu_cores</span>
</span></span><span class=line><span class=cl><span class=n>    type</span>  <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>cpu_type</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>memory</span> {
</span></span><span class=line><span class=cl><span class=n>    dedicated</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>memory_mb</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>efi_disk</span> {
</span></span><span class=line><span class=cl><span class=n>    datastore_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>datastore_id</span>
</span></span><span class=line><span class=cl><span class=n>    type</span>         <span class=o>=</span> <span class=s2>&#34;4m&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>disk</span> {
</span></span><span class=line><span class=cl><span class=n>    datastore_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>datastore_id</span>
</span></span><span class=line><span class=cl><span class=n>    file_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>disk_file_id</span>
</span></span><span class=line><span class=cl><span class=n>    interface</span>    <span class=o>=</span> <span class=s2>&#34;virtio0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    iothread</span>     <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>    discard</span>      <span class=o>=</span> <span class=s2>&#34;on&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    size</span>         <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>disk_size_gb</span>
</span></span><span class=line><span class=cl><span class=n>    ssd</span>          <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>network_device</span> {
</span></span><span class=line><span class=cl><span class=n>    bridge</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>bridge</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>initialization</span> {
</span></span><span class=line><span class=cl>    <span class=k>dns</span> {
</span></span><span class=line><span class=cl><span class=n>      servers</span> <span class=o>=</span> <span class=p>[</span><span class=k>var</span><span class=p>.</span><span class=k>dns_server</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>ip_config</span> {
</span></span><span class=line><span class=cl>      <span class=k>ipv4</span> {
</span></span><span class=line><span class=cl><span class=n>        address</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>ip_address</span>
</span></span><span class=line><span class=cl><span class=n>        gateway</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>ip_gateway</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>    user_data_file_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>user_data_file_id</span>
</span></span><span class=line><span class=cl><span class=n>    meta_data_file_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>meta_data_file_id</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h3 class="relative group"><code>vms.tf</code>: Orchestrating the Build with <code>for_each</code><div id=vmstf-orchestrating-the-build-with-for_each class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#vmstf-orchestrating-the-build-with-for_each aria-label=Anchor>#</a></span></h3><p>Now for the magic. All that setup—the variables, the JSON file, the module—was for this. This one file is our master orchestration file. Watch how we use for_each to loop through our JSON node list and pass the values to our VM module. This is how we create 12 (or 100) VMs as easily as one.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;k8s_nodes&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span> <span class=o>=</span> <span class=s2>&#34;./modules/vm&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  for_each</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>k8s_nodes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span>              <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>key</span>
</span></span><span class=line><span class=cl><span class=n>  node_name</span>         <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>node</span>
</span></span><span class=line><span class=cl><span class=n>  vm_id</span>             <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>vm_id</span>
</span></span><span class=line><span class=cl><span class=n>  cpu_cores</span>         <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>k8s_cpu_cores</span>
</span></span><span class=line><span class=cl><span class=n>  cpu_type</span>          <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>k8s_cpu_type</span>
</span></span><span class=line><span class=cl><span class=n>  memory_mb</span>         <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>k8s_memory_mb</span>
</span></span><span class=line><span class=cl><span class=n>  datastore_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>k8s_datastore_id</span>
</span></span><span class=line><span class=cl><span class=n>  disk_file_id</span>      <span class=o>=</span> <span class=k>proxmox_virtual_environment_download_file</span><span class=p>.</span><span class=k>ubuntu_cloud_image</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  disk_size_gb</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>k8s_disk_size_gb</span>
</span></span><span class=line><span class=cl><span class=n>  bridge</span>            <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_bridge</span>
</span></span><span class=line><span class=cl><span class=n>  dns_server</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>dns_server</span>
</span></span><span class=line><span class=cl><span class=n>  ip_address</span>        <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>address</span>
</span></span><span class=line><span class=cl><span class=n>  ip_gateway</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_ip_gateway</span>
</span></span><span class=line><span class=cl><span class=n>  user_data_file_id</span> <span class=o>=</span> <span class=k>proxmox_virtual_environment_file</span><span class=p>.</span><span class=k>user_data_cloud_config</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  meta_data_file_id</span> <span class=o>=</span> <span class=k>proxmox_virtual_environment_file</span><span class=p>.</span><span class=k>meta_data_cloud_config</span><span class=p>[</span><span class=k>each</span><span class=p>.</span><span class=k>key</span><span class=p>].</span><span class=k>id</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;longhorn_nodes&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span> <span class=o>=</span> <span class=s2>&#34;./modules/vm&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  for_each</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>longhorn_nodes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span>              <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>key</span>
</span></span><span class=line><span class=cl><span class=n>  node_name</span>         <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>node</span>
</span></span><span class=line><span class=cl><span class=n>  vm_id</span>             <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>vm_id</span>
</span></span><span class=line><span class=cl><span class=n>  cpu_cores</span>         <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>longhorn_cpu_cores</span>
</span></span><span class=line><span class=cl><span class=n>  cpu_type</span>          <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>longhorn_cpu_type</span>
</span></span><span class=line><span class=cl><span class=n>  memory_mb</span>         <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>longhorn_memory_mb</span>
</span></span><span class=line><span class=cl><span class=n>  datastore_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>longhorn_datastore_id</span>
</span></span><span class=line><span class=cl><span class=n>  disk_file_id</span>      <span class=o>=</span> <span class=k>proxmox_virtual_environment_download_file</span><span class=p>.</span><span class=k>ubuntu_cloud_image</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  disk_size_gb</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>longhorn_disk_size_gb</span>
</span></span><span class=line><span class=cl><span class=n>  bridge</span>            <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_bridge</span>
</span></span><span class=line><span class=cl><span class=n>  dns_server</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>dns_server</span>
</span></span><span class=line><span class=cl><span class=n>  ip_address</span>        <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>address</span>
</span></span><span class=line><span class=cl><span class=n>  ip_gateway</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vm_ip_gateway</span>
</span></span><span class=line><span class=cl><span class=n>  user_data_file_id</span> <span class=o>=</span> <span class=k>proxmox_virtual_environment_file</span><span class=p>.</span><span class=k>user_data_cloud_config</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  meta_data_file_id</span> <span class=o>=</span> <span class=k>proxmox_virtual_environment_file</span><span class=p>.</span><span class=k>meta_data_cloud_config</span><span class=p>[</span><span class=k>each</span><span class=p>.</span><span class=k>key</span><span class=p>].</span><span class=k>id</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>For every entry in <code>local.k8s_nodes</code> (and <code>longhorn_nodes</code>) variables, this file calls the <code>./modules/vm</code> module, passing in the specific configuration. It combines:</p><ul><li>The node-specific data from the JSON file (<code>each.key</code>, <code>each.value.address</code>).</li><li>The generic VM settings from <code>main.tfvars</code> (<code>var.k8s_cpu_cores</code>).</li><li>The IDs of the resources created in other files (the downloaded image and the cloud-init snippets).</li></ul><p>Result:<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/BVbF4X9q/image.png></figure></p><h2 class="relative group">Conclusion: The 12-Hour, 12-Minute Payoff<div id=conclusion-the-12-hour-12-minute-payoff class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#conclusion-the-12-hour-12-minute-payoff aria-label=Anchor>#</a></span></h2><p>And with that, I&rsquo;ve successfully created 12 VMs on Proxmox, all with specific, defined configurations, just by running terraform apply.</p><p>You could say I took 12 hours to automate a 12-minute job, and you&rsquo;d be right. But I&rsquo;m still incredibly proud of this work. Now, I can spin down the entire cluster and spin it back up again, at will, in minutes. What&rsquo;s more, I can scale up or change the configuration for all my VMs just by editing a single JSON file.</p><p>That is the power of well-designed Infrastructure as Code.</p></div><details class="mt-2 mb-5 overflow-hidden rounded-lg ms-0 ps-5"><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 -ms-5 ps-5 dark:bg-primary-800 dark:text-neutral-100">On-Premise 101 -
This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/111/posts/on-premise-hardware/>Part 1:
On-Premise 101 (Part 1): Building a 3-Node Cluster</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/111/posts/on-premise-hypervisor/>Part 2:
On-Premise 101 (Part 2): Proxmox, the "Glue" for My Homelab</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/111/posts/on-premise-storage/>Part 3:
On-Premise 101 (Part 3): My "Fearless" NAS Build with Virtualized TrueNAS, ZFS, and Cloud Backups</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">Part 4:
This Article</div></details><h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><article class="relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src=/previews/111/mlops1-arch.excalidraw_16782172796396726828.svg alt="Scalable Real-Time Credit Card Fraud Detection System" loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class="px-6 py-4"><header><a href=https://github.com/phuchoang2603/realtime-credit-card-fraud-detection target=_blank rel=external class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Scalable Real-Time Credit Card Fraud Detection System
<span class="cursor-default align-top text-xs text-neutral-400 dark:text-neutral-500"><span class=rtl:hidden>&#8599;</span>
<span class=ltr:hidden>&#8598;</span></span></h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-11-06T00:00:00+00:00>6 November 2025</time></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/argo-cd/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Argo-Cd
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/kubernetes/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/github-actions/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Github-Actions
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/terraform/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Terraform
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/grafana/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Grafana
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/prometheus/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Prometheus
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/python/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Python
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/cloud/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cloud</span></span></a></div></div><div class="prose dark:prose-invert py-1">This repository contains a complete end-to-end system for real-time credit card fraud detection, including data analysis notebooks, a machine learning API, and infrastructure-as-code for cloud deployment. The system is designed with a modern, observable, and scalable architecture.</div></div><div class="px-6 pt-4 pb-2"></div></article><article class="relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src=/previews/111/image_11647519231104458962_hu_33f4d45946002114.png alt="Automate provisioning Kubernetes cluster on Proxmox with Terraform + Ansible" loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class="px-6 py-4"><header><a href=https://github.com/phuchoang2603/kubernetes-proxmox target=_blank rel=external class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Automate provisioning Kubernetes cluster on Proxmox with Terraform + Ansible
<span class="cursor-default align-top text-xs text-neutral-400 dark:text-neutral-500"><span class=rtl:hidden>&#8599;</span>
<span class=ltr:hidden>&#8598;</span></span></h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-05-31T00:00:00+00:00>31 May 2025</time></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/kubernetes/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/proxmox/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Proxmox
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/terraform/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Terraform
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/ansible/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Ansible</span></span></a></div></div><div class="prose dark:prose-invert py-1">This project automates the provisioning and configuration of a RKE2 Kubernetes cluster on Proxmox using Terraform and Ansible.</div></div><div class="px-6 pt-4 pb-2"></div></article><article class="relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src=/previews/111/image_17980819193739638696_hu_3784e8c9d5c55a31.png alt='On-Premise 101 (Part 3): My "Fearless" NAS Build with Virtualized TrueNAS, ZFS, and Cloud Backups' loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class="px-6 py-4"><header><a href=/previews/111/posts/on-premise-storage/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>On-Premise 101 (Part 3): My "Fearless" NAS Build with Virtualized TrueNAS, ZFS, and Cloud Backups</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-11-02T00:00:00+00:00>2 November 2025</time><span class="px-2 text-primary-500">&#183;</span><span>3166 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">15 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/on-premise-storage.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span>
</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/on-premise-storage.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/proxmox/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Proxmox
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/111/tags/truenas/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Truenas</span></span></a></div></div><div class="prose dark:prose-invert py-1">In the previous parts of this series, we went from a single hand-me-down PC to a full 3-node cluster, and then we installed Proxmox as our hypervisor. We even managed to pass through a GPU to a VM for near-native performance.</div></div><div class="px-6 pt-4 pb-2"></div></article></section></div><script type=text/javascript src=/previews/111/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_posts/on-premise-provision-terraform.md data-oid-likes=likes_posts/on-premise-provision-terraform.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/previews/111/posts/arxiv-n8n-docling/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Building an AI-Powered ArXiv Pipeline: Thought n8n was the future, but not yet
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-11-02T00:00:00+00:00>2 November 2025</time>
</span></span><span class="flex flex-col items-end"></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=phuchoang2603/phuchoang2603.github.io data-repo-id=R_kgDOOUB0Ww data-category=General data-category-id=DIC_kwDOOUB0W84Coz7q data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></footer></article><div id=scroll-to-top class="fixed bottom-24 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Felix Hoang</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/previews/111/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://phuchoang2603.github.io/previews/111/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>