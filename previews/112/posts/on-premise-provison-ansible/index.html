<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>On-Premise 101 (Part 5): From Terraform VMs to a K8s Cluster with Ansible &#183; /home/fel1x</title><meta name=title content="On-Premise 101 (Part 5): From Terraform VMs to a K8s Cluster with Ansible &#183; /home/fel1x"><meta name=description content="A blog about my life, my projects and my thoughts"><meta name=keywords content="ansible,kubernetes,proxmox,cloud,"><link rel=canonical href=https://phuchoang2603.github.io/previews/112/posts/on-premise-provison-ansible/><meta name=author content="Felix Hoang"><link href=https://github.com/phuchoang2603 rel=me><link href=https://linkedin.com/in/phuchoang2603 rel=me><meta property="og:url" content="https://phuchoang2603.github.io/previews/112/posts/on-premise-provison-ansible/"><meta property="og:site_name" content="/home/fel1x"><meta property="og:title" content="On-Premise 101 (Part 5): From Terraform VMs to a K8s Cluster with Ansible"><meta property="og:description" content="People are often scared to learn Kubernetes because it’s difficult to set up an environment to play around with. Sure, you can use a project like minikube to learn on your own, but running it on your laptop seems limited, and you may not get to experience all the awesome features Kubernetes offers (remember, it was born for high availability). Or, if you have money, you can use a managed Kubernetes cluster from one of the cloud providers (Amazon Elastic Kubernetes Service, Google Kubernetes Engine, Azure Kubernetes Service). Often, they’ve abstracted away so many things under the hood that you only need to learn kubectl and you’re good to go."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-11T00:00:00+00:00"><meta property="article:modified_time" content="2025-11-11T00:00:00+00:00"><meta property="article:tag" content="Ansible"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Proxmox"><meta property="article:tag" content="Cloud"><meta property="og:see_also" content="https://phuchoang2603.github.io/previews/112/posts/on-premise-provision-terraform/"><meta property="og:see_also" content="https://phuchoang2603.github.io/previews/112/posts/on-premise-storage/"><meta property="og:see_also" content="https://phuchoang2603.github.io/previews/112/posts/on-premise-hypervisor/"><meta property="og:see_also" content="https://phuchoang2603.github.io/previews/112/posts/on-premise-hardware/"><meta name=twitter:card content="summary"><meta name=twitter:title content="On-Premise 101 (Part 5): From Terraform VMs to a K8s Cluster with Ansible"><meta name=twitter:description content="People are often scared to learn Kubernetes because it’s difficult to set up an environment to play around with. Sure, you can use a project like minikube to learn on your own, but running it on your laptop seems limited, and you may not get to experience all the awesome features Kubernetes offers (remember, it was born for high availability). Or, if you have money, you can use a managed Kubernetes cluster from one of the cloud providers (Amazon Elastic Kubernetes Service, Google Kubernetes Engine, Azure Kubernetes Service). Often, they’ve abstracted away so many things under the hood that you only need to learn kubectl and you’re good to go."><meta name=google-site-verification content="ZN_K5PVRzd6d5xDuzqI-4N_QI1YUnMWqf7T8rlXMUzg"><link type=text/css rel=stylesheet href=/previews/112/css/main.bundle.min.2eafb51bdb78418e5b035d7c8ece02c448e0391ea702d3d87ae70f1941f3e98bfe534b478047cb61a3b44503c2094ac025de366efdf454ad0766e666165e8a93.css integrity="sha512-Lq+1G9t4QY5bA118js4CxEjgOR6nAtPYeucPGUHz6Yv+U0tHgEfLYaO0RQPCCUrAJd42bv30VK0HZuZmFl6Kkw=="><script type=text/javascript src=/previews/112/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script type=text/javascript src=/previews/112/js/zen-mode.min.9814dee9614d32aeb56239d118edfe20acd6231424f9b19c2dd48835038414130a5e946c0d1c9087d60e60e31840c9babfd217e3d4b95643dc8d651a71ccdf4a.js integrity="sha512-mBTe6WFNMq61YjnRGO3+IKzWIxQk+bGcLdSINQOEFBMKXpRsDRyQh9YOYOMYQMm6v9IX49S5VkPcjWUacczfSg=="></script><script src=/previews/112/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/previews/112/js/main.bundle.min.9cc802d09f28c6af56ceee7bc6e320a39251fdae98243f2a9942f221ac57a9f49c51609699a91794a7b2580ee1deaa8e4d794a68ffa94aa317c66e893ce51e02.js integrity="sha512-nMgC0J8oxq9Wzu57xuMgo5JR/a6YJD8qmULyIaxXqfScUWCWmakXlKeyWA7h3qqOTXlKaP+pSqMXxm6JPOUeAg==" data-copy=Copy data-copied=Copied></script><script src=/previews/112/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link type=text/css rel=stylesheet href=/previews/112/lib/lite-youtube-embed/lite-yt-embed.badabc6055b427669bbcf084097334cdf2029c85696c4a56e25239825d3571d26ef82b775ba19032ccd52135ccb412c9ba79da4e9e9b6f3939a6178a5f65ee5d.css integrity="sha512-utq8YFW0J2abvPCECXM0zfICnIVpbEpW4lI5gl01cdJu+Ct3W6GQMszVITXMtBLJunnaTp6bbzk5pheKX2XuXQ=="><script type=text/javascript src=/previews/112/lib/lite-youtube-embed/lite-yt-embed.58a8a22aed9d1cd05780869df4b0d87972fcd144a9eaff8f9a1453e58e6521c5a89ccd80bdb9f48e25ae5ee87b98bd9de51b14dd9988c60e4c89630433292084.js integrity="sha512-WKiiKu2dHNBXgIad9LDYeXL80USp6v+PmhRT5Y5lIcWonM2Avbn0jiWuXuh7mL2d5RsU3ZmIxg5MiWMEMykghA=="></script><link rel=stylesheet href=/previews/112/previews/112/posts/on-premise-provison-ansible/repo-cards.min.1ab70b567e12600d5380b03f10cb62bc333f1cf10c124f2fa2f4c77a49b19672f8e58023bf4b24033473916a8d18c3856ae26fd7c6c08b511c0d1aa6f4d48e99.css integrity="sha512-GrcLVn4SYA1TgLA/EMtivDM/HPEMEk8vovTHekmxlnL45YAjv0skAzRzkWqNGMOFauJv18bAi1EcDRqm9NSOmQ=="><link rel=apple-touch-icon sizes=180x180 href=/previews/112/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/previews/112/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/previews/112/favicon-16x16.png><link rel=manifest href=/previews/112/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"On-Premise 101 (Part 5): From Terraform VMs to a K8s Cluster with Ansible","headline":"On-Premise 101 (Part 5): From Terraform VMs to a K8s Cluster with Ansible","abstract":"\u003cp\u003ePeople are often scared to learn \u003ccode\u003eKubernetes\u003c\/code\u003e because it\u0026rsquo;s difficult to set up an environment to play around with. Sure, you can use a project like \u003ccode\u003eminikube\u003c\/code\u003e to learn on your own, but running it on your laptop seems limited, and you may not get to experience all the awesome features \u003ccode\u003eKubernetes\u003c\/code\u003e offers (remember, it was born for high availability). Or, if you have money, you can use a managed \u003ccode\u003eKubernetes\u003c\/code\u003e cluster from one of the cloud providers (\u003ccode\u003eAmazon Elastic Kubernetes Service\u003c\/code\u003e, \u003ccode\u003eGoogle Kubernetes Engine\u003c\/code\u003e, \u003ccode\u003eAzure Kubernetes Service\u003c\/code\u003e). Often, they\u0026rsquo;ve abstracted away so many things under the hood that you only need to learn \u003ccode\u003ekubectl\u003c\/code\u003e and you\u0026rsquo;re good to go.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/phuchoang2603.github.io\/previews\/112\/posts\/on-premise-provison-ansible\/","author":{"@type":"Person","name":"Felix Hoang"},"copyrightYear":"2025","dateCreated":"2025-11-11T00:00:00\u002b00:00","datePublished":"2025-11-11T00:00:00\u002b00:00","dateModified":"2025-11-11T00:00:00\u002b00:00","keywords":["ansible","kubernetes","proxmox","cloud"],"mainEntityOfPage":"true","wordCount":"3835"}]</script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js></script><script>const firebaseConfig={apiKey:"AIzaSyCJUh8_eWSkkvDZwHdrPNBdyke7Dk422uI",authDomain:"phuchoang-sbs.firebaseapp.com",projectId:"phuchoang-sbs",storageBucket:"phuchoang-sbs.firebasestorage.app",messagingSenderId:"359041758586",appId:"1:359041758586:web:12cabd41bb64a6bda452c3",measurementId:"G-HVDVFDQDMC"};var app=firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth()</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom bg-neutral dark:bg-neutral-800"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/previews/112/ class="text-base font-medium">/home/fel1x</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/previews/112/posts/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/posts title=Posts><p class="text-base font-medium">/posts</p></a><a href=/previews/112/series/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=series title=Series><p class="text-base font-medium">series</p></a><a href=/previews/112/projects/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/projects title=Projects><p class="text-base font-medium">/projects</p></a><a href=/previews/112/tags/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=tags title=Tags><p class="text-base font-medium">tags</p></a><a href=/previews/112/about/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/about title="Welcome to my blog!"><p class="text-base font-medium">/about</p></a><a href=https://github.com/phuchoang2603 target=_blank class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=github title><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a href class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" title></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 me-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/previews/112/posts/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/posts title=Posts><p class="text-bg font-bg">/posts</p></a></li><li class=mt-1><a href=/previews/112/series/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=series title=Series><p class="text-bg font-bg">series</p></a></li><li class=mt-1><a href=/previews/112/projects/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/projects title=Projects><p class="text-bg font-bg">/projects</p></a></li><li class=mt-1><a href=/previews/112/tags/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=tags title=Tags><p class="text-bg font-bg">tags</p></a></li><li class=mt-1><a href=/previews/112/about/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=/about title="Welcome to my blog!"><p class="text-bg font-bg">/about</p></a></li><li class=mt-1><a href=https://github.com/phuchoang2603 target=_blank class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=github title><div><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></div></a></li><li class=mt-1><a href class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" title></a></li></ul></div></div></div></div></div></div><script type=text/javascript src=/previews/112/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=/previews/112/image_11962639403746028666_hu_c28d6fcf6a424746.png alt="On-Premise 101 (Part 5): From Terraform VMs to a K8s Cluster with Ansible" loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script type=text/javascript src=/previews/112/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=background-blur data-image-id=background-image data-image-url=/previews/112/image_11962639403746028666_hu_c28d6fcf6a424746.png></script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">On-Premise 101 (Part 5): From Terraform VMs to a K8s Cluster with Ansible</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-11-11T00:00:00+00:00>11 November 2025</time><span class="px-2 text-primary-500">&#183;</span><span>3835 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">19 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/on-premise-provison-ansible.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span>
</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/on-premise-provison-ansible.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span>
</span><span class="px-2 text-primary-500">&#183;</span><span>
<button id=button_likes class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
<span id=button_likes_heart class="inline-block align-text-bottom hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span>
</span><span id=button_likes_emtpty_heart class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M244 84l11.1 12 12-11.98C300.6 51.37 347 36.51 392.6 44.1 461.5 55.58 512 115.2 512 185.1V190.9c0 41.5-17.2 81.2-47.6 109.5L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9S235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1.0 232.4.0 190.9V185.1c0-69.9 50.52-129.52 119.4-141 44.7-7.59 92 7.27 124.6 39.9C243.1 84 244 84.01 244 84zm11.1 79.9-45-46.8c-21.7-20.82-52.5-30.7-82.8-25.66C81.55 99.07 48 138.7 48 185.1V190.9c0 28.2 11.71 55.2 32.34 74.4L256 429.3l175.7-164c20.6-19.2 32.3-46.2 32.3-74.4V185.1c0-46.4-33.6-86.03-79.3-93.66C354.4 86.4 323.6 96.28 301.9 117.1l-46.8 46.8z"/></svg></span></span>
<span id=button_likes_text>&nbsp;Like</span>
</button>
</span><span class="px-2 text-primary-500">&#183;</span><span class=mb-[2px]>
<span id=zen-mode-button class="text-lg hover:text-primary-500" title="Enable zen mode" data-title-i18n-disable="Enable zen mode" data-title-i18n-enable="Disable zen mode"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentColor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/ansible/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Ansible
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/kubernetes/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/proxmox/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Proxmox
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/cloud/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cloud</span></span></a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#my-k8s-flavor>My K8s Flavor</a><ul><li><a href=#what-is-rke2-according-to-the-documentation>What is RKE2? (according to the documentation)</a></li><li><a href=#how-is-this-different-from-rke-or-k3s>How is this different from RKE or K3s?</a></li><li><a href=#rke2-architecture>RKE2 Architecture</a></li><li><a href=#a-30-second-kubernetes-refresher>A 30-Second Kubernetes Refresher</a></li></ul></li><li><a href=#the-elephant-in-the-room-terraform-vs-ansible>The Elephant in the Room: Terraform vs. Ansible</a></li><li><a href=#my-automation-workflow-from-terraform-to-ansible>My Automation Workflow: From Terraform to Ansible</a><ul><li><a href=#phase-1-terraform-builds-the-house-covered-in-part-4>Phase 1: Terraform Builds the House (Covered in Part 4)</a></li><li><a href=#the-handoff-our-terraform-to-ansible-glue>The Handoff: Our &ldquo;Terraform-to-Ansible&rdquo; Glue</a></li><li><a href=#phase-2-ansible-furnishes-the-house>Phase 2: Ansible Furnishes the House</a></li></ul></li><li><a href=#setting-the-stage-ansible-inventory-and-variables>Setting the Stage: Ansible Inventory and Variables</a></li><li><a href=#the-master-plan-our-siteyaml-playbook>The Master Plan: Our site.yaml Playbook</a></li><li><a href=#the-playbook-in-action-a-step-by-step-breakdown>The Playbook in Action: A Step-by-Step Breakdown</a><ul><li><a href=#1-prepare-all-nodes--download-rke2>1. Prepare All Nodes & Download RKE2</a></li><li><a href=#2-bootstrapping-the-control-plane-add-server>2. Bootstrapping the Control Plane (add-server)</a></li><li><a href=#3-joining-the-worker-nodes-add-agent>3. Joining the Worker Nodes (add-agent)</a></li><li><a href=#4-high-availability-with-kube-vip>4. High Availability with Kube-VIP</a></li><li><a href=#5-ingress-and-ssl-with-traefik--cert-manager>5. Ingress and SSL with Traefik & Cert-Manager</a></li><li><a href=#6-deploying-core-services-longhorn--argocd>6. Deploying Core Services (Longhorn & ArgoCD)</a><ul><li><a href=#longhorn-for-persistent-replicated-storage>Longhorn: For Persistent, Replicated Storage</a></li><li><a href=#argocd-our-gitops-engine>ArgoCD: Our GitOps Engine</a></li></ul></li></ul></li><li><a href=#the-final-handoff-getting-kubectl-access>The Final Handoff: Getting kubectl Access</a></li><li><a href=#verification>Verification</a></li><li><a href=#summary--next-steps>Summary & Next Steps</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#my-k8s-flavor>My K8s Flavor</a><ul><li><a href=#what-is-rke2-according-to-the-documentation>What is RKE2? (according to the documentation)</a></li><li><a href=#how-is-this-different-from-rke-or-k3s>How is this different from RKE or K3s?</a></li><li><a href=#rke2-architecture>RKE2 Architecture</a></li><li><a href=#a-30-second-kubernetes-refresher>A 30-Second Kubernetes Refresher</a></li></ul></li><li><a href=#the-elephant-in-the-room-terraform-vs-ansible>The Elephant in the Room: Terraform vs. Ansible</a></li><li><a href=#my-automation-workflow-from-terraform-to-ansible>My Automation Workflow: From Terraform to Ansible</a><ul><li><a href=#phase-1-terraform-builds-the-house-covered-in-part-4>Phase 1: Terraform Builds the House (Covered in Part 4)</a></li><li><a href=#the-handoff-our-terraform-to-ansible-glue>The Handoff: Our &ldquo;Terraform-to-Ansible&rdquo; Glue</a></li><li><a href=#phase-2-ansible-furnishes-the-house>Phase 2: Ansible Furnishes the House</a></li></ul></li><li><a href=#setting-the-stage-ansible-inventory-and-variables>Setting the Stage: Ansible Inventory and Variables</a></li><li><a href=#the-master-plan-our-siteyaml-playbook>The Master Plan: Our site.yaml Playbook</a></li><li><a href=#the-playbook-in-action-a-step-by-step-breakdown>The Playbook in Action: A Step-by-Step Breakdown</a><ul><li><a href=#1-prepare-all-nodes--download-rke2>1. Prepare All Nodes & Download RKE2</a></li><li><a href=#2-bootstrapping-the-control-plane-add-server>2. Bootstrapping the Control Plane (add-server)</a></li><li><a href=#3-joining-the-worker-nodes-add-agent>3. Joining the Worker Nodes (add-agent)</a></li><li><a href=#4-high-availability-with-kube-vip>4. High Availability with Kube-VIP</a></li><li><a href=#5-ingress-and-ssl-with-traefik--cert-manager>5. Ingress and SSL with Traefik & Cert-Manager</a></li><li><a href=#6-deploying-core-services-longhorn--argocd>6. Deploying Core Services (Longhorn & ArgoCD)</a><ul><li><a href=#longhorn-for-persistent-replicated-storage>Longhorn: For Persistent, Replicated Storage</a></li><li><a href=#argocd-our-gitops-engine>ArgoCD: Our GitOps Engine</a></li></ul></li></ul></li><li><a href=#the-final-handoff-getting-kubectl-access>The Final Handoff: Getting kubectl Access</a></li><li><a href=#verification>Verification</a></li><li><a href=#summary--next-steps>Summary & Next Steps</a></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!0,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><details class="mt-2 mb-5 overflow-hidden rounded-lg ms-0 ps-5" open><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 -ms-5 ps-5 dark:bg-primary-800 dark:text-neutral-100">On-Premise 101 -
This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/112/posts/on-premise-hardware/>Part 1:
On-Premise 101 (Part 1): Building a 3-Node Cluster</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/112/posts/on-premise-hypervisor/>Part 2:
On-Premise 101 (Part 2): Proxmox, the "Glue" for My Homelab</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/112/posts/on-premise-storage/>Part 3:
On-Premise 101 (Part 3): My "Fearless" NAS Build with Virtualized TrueNAS, ZFS, and Cloud Backups</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/112/posts/on-premise-provision-terraform/>Part 4:
On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">Part 5:
This Article</div></details><div class="article-content max-w-prose mb-20"><p>People are often scared to learn <code>Kubernetes</code> because it&rsquo;s difficult to set up an environment to play around with. Sure, you can use a project like <code>minikube</code> to learn on your own, but running it on your laptop seems limited, and you may not get to experience all the awesome features <code>Kubernetes</code> offers (remember, it was born for high availability). Or, if you have money, you can use a managed <code>Kubernetes</code> cluster from one of the cloud providers (<code>Amazon Elastic Kubernetes Service</code>, <code>Google Kubernetes Engine</code>, <code>Azure Kubernetes Service</code>). Often, they&rsquo;ve abstracted away so many things under the hood that you only need to learn <code>kubectl</code> and you&rsquo;re good to go.</p><p>However, if you encounter issues, you might find it hard to debug those services, likely because you just don&rsquo;t have to touch the internals frequently. I mean, who in their right mind would <em>break things</em> on a cluster frequently and debug it just for the sake of learning?</p><p>Well, I do. But since I already have my own homelab, I decided to experiment on that rather than on a managed cloud cluster.</p><p>What&rsquo;s more, this also gives me the option to properly deploy <code>Kubernetes</code> from the ground up. I also want to automate all the steps I&rsquo;ve gone through so that I can reverse something and run it all back if it goes wrong. After creating 12 VMs with Terraform in the previous part, this post is the second part of my deep dive on the project below, focusing on how I use <strong><code>Ansible</code></strong> to automate the deployment of Kubernetes on those VMs.</p><div class=github-card-wrapper><a id=github-5888fd14b17d5825c8b19b95cbd98835 target=_blank href=https://github.com/phuchoang2603/kubernetes-proxmox class=cursor-pointer><div class="w-full md:w-auto p-0 m-0 border border-neutral-200 dark:border-neutral-700 border rounded-md shadow-2xl"><div class="w-full nozoom"><img src=https://opengraph.githubassets.com/0/phuchoang2603/kubernetes-proxmox alt="GitHub Repository Thumbnail" class="nozoom mt-0 mb-0 w-full h-full object-cover"></div><div class="w-full md:w-auto pt-3 p-5"><div class="flex items-center"><span class="text-2xl text-neutral-800 dark:text-neutral me-2"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><div id=github-5888fd14b17d5825c8b19b95cbd98835-full_name class="m-0 font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral">phuchoang2603/kubernetes-proxmox</div></div><p id=github-5888fd14b17d5825c8b19b95cbd98835-description class="m-0 mt-2 text-md text-neutral-800 dark:text-neutral">auto provision and deploy k8s to proxmox using terraform + ansible</p><div class="m-0 mt-2 flex items-center"><span class="mr-1 inline-block h-3 w-3 rounded-full language-dot" data-language=Jinja></span><div class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">Jinja</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></span><div id=github-5888fd14b17d5825c8b19b95cbd98835-stargazers class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">7</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M80 104c13.3.0 24-10.7 24-24S93.3 56 80 56 56 66.7 56 80s10.7 24 24 24zm80-24c0 32.8-19.7 61-48 73.3V192c0 17.7 14.3 32 32 32H304c17.7.0 32-14.3 32-32V153.3C307.7 141 288 112.8 288 80c0-44.2 35.8-80 80-80s80 35.8 80 80c0 32.8-19.7 61-48 73.3V192c0 53-43 96-96 96H256v70.7c28.3 12.3 48 40.5 48 73.3.0 44.2-35.8 80-80 80s-80-35.8-80-80c0-32.8 19.7-61 48-73.3V288H144c-53 0-96-43-96-96V153.3C19.7 141 0 112.8.0 80 0 35.8 35.8.0 80 0s80 35.8 80 80zm208 24c13.3.0 24-10.7 24-24s-10.7-24-24-24-24 10.7-24 24 10.7 24 24 24zM248 432c0-13.3-10.7-24-24-24s-24 10.7-24 24 10.7 24 24 24 24-10.7 24-24z"/></svg></span></span><div id=github-5888fd14b17d5825c8b19b95cbd98835-forks class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">0</div></div></div></div><script async type=text/javascript src=/previews/112/js/fetch-repo.min.dc5533c50cefd50405344b235937142271f26229fe39cbee27fd4960e8bb897a0beebfad77a1091ca91cd0d1fb14e70fc37cc114dd9674fb2c32e0ab512ec8a4.js integrity="sha512-3FUzxQzv1QQFNEsjWTcUInHyYin+OcvuJ/1JYOi7iXoL7r+td6EJHKkc0NH7FOcPw3zBFN2WdPssMuCrUS7IpA==" data-repo-url=https://api.github.com/repos/phuchoang2603/kubernetes-proxmox data-repo-id=github-5888fd14b17d5825c8b19b95cbd98835></script></a></div><p>Video demo:</p><lite-youtube videoid=IrlKAG5bctk playlabel=IrlKAG5bctk params></lite-youtube><h2 class="relative group">My K8s Flavor<div id=my-k8s-flavor class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#my-k8s-flavor aria-label=Anchor>#</a></span></h2><p>Before we dive in, I have to say that we are <strong>not</strong> going to bootstrap a basic Kubernetes cluster from the ground up as detailed in the project below. However, I <em>absolutely</em> recommend anyone who wants to learn it from the beginning to go through this project. The reason I&rsquo;m not using it is that it&rsquo;s not recommended for daily <em>usage</em>. Instead, I will use <strong>RKE2</strong>, which is more production-ready but still offers a great learning experience.</p><div class=github-card-wrapper><a id=github-433c421d17a5327cd0393bdb8e27fecf target=_blank href=https://github.com/kelseyhightower/kubernetes-the-hard-way class=cursor-pointer><div class="w-full md:w-auto p-0 m-0 border border-neutral-200 dark:border-neutral-700 border rounded-md shadow-2xl"><div class="w-full nozoom"><img src=https://opengraph.githubassets.com/0/kelseyhightower/kubernetes-the-hard-way alt="GitHub Repository Thumbnail" class="nozoom mt-0 mb-0 w-full h-full object-cover"></div><div class="w-full md:w-auto pt-3 p-5"><div class="flex items-center"><span class="text-2xl text-neutral-800 dark:text-neutral me-2"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><div id=github-433c421d17a5327cd0393bdb8e27fecf-full_name class="m-0 font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral">kelseyhightower/kubernetes-the-hard-way</div></div><p id=github-433c421d17a5327cd0393bdb8e27fecf-description class="m-0 mt-2 text-md text-neutral-800 dark:text-neutral">Bootstrap Kubernetes the hard way. No scripts.</p><div class="m-0 mt-2 flex items-center"><span class="mr-1 inline-block h-3 w-3 rounded-full language-dot" data-language=default></span><div class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">null</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></span><div id=github-433c421d17a5327cd0393bdb8e27fecf-stargazers class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">46318</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M80 104c13.3.0 24-10.7 24-24S93.3 56 80 56 56 66.7 56 80s10.7 24 24 24zm80-24c0 32.8-19.7 61-48 73.3V192c0 17.7 14.3 32 32 32H304c17.7.0 32-14.3 32-32V153.3C307.7 141 288 112.8 288 80c0-44.2 35.8-80 80-80s80 35.8 80 80c0 32.8-19.7 61-48 73.3V192c0 53-43 96-96 96H256v70.7c28.3 12.3 48 40.5 48 73.3.0 44.2-35.8 80-80 80s-80-35.8-80-80c0-32.8 19.7-61 48-73.3V288H144c-53 0-96-43-96-96V153.3C19.7 141 0 112.8.0 80 0 35.8 35.8.0 80 0s80 35.8 80 80zm208 24c13.3.0 24-10.7 24-24s-10.7-24-24-24-24 10.7-24 24 10.7 24 24 24zM248 432c0-13.3-10.7-24-24-24s-24 10.7-24 24 10.7 24 24 24 24-10.7 24-24z"/></svg></span></span><div id=github-433c421d17a5327cd0393bdb8e27fecf-forks class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">15284</div></div></div></div><script async type=text/javascript src=/previews/112/js/fetch-repo.min.dc5533c50cefd50405344b235937142271f26229fe39cbee27fd4960e8bb897a0beebfad77a1091ca91cd0d1fb14e70fc37cc114dd9674fb2c32e0ab512ec8a4.js integrity="sha512-3FUzxQzv1QQFNEsjWTcUInHyYin+OcvuJ/1JYOi7iXoL7r+td6EJHKkc0NH7FOcPw3zBFN2WdPssMuCrUS7IpA==" data-repo-url=https://api.github.com/repos/kelseyhightower/kubernetes-the-hard-way data-repo-id=github-433c421d17a5327cd0393bdb8e27fecf></script></a></div><h3 class="relative group">What is RKE2? (according to the <a href=https://docs.rke2.io/ target=_blank>documentation</a>)<div id=what-is-rke2-according-to-the-documentation class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#what-is-rke2-according-to-the-documentation aria-label=Anchor>#</a></span></h3><p>RKE2 is Rancher&rsquo;s enterprise-ready, next-generation Kubernetes distribution. It&rsquo;s also been known as RKE Government. It is a fully <a href="https://landscape.cncf.io/?group=projects-and-products&amp;view-mode=card&amp;item=platform--certified-kubernetes-distribution--rke-government#app-definition-and-development--application-definition-image-build" target=_blank>conformant Kubernetes distribution</a> that focuses on security and compliance.</p><p>To meet these goals, RKE2 does the following:</p><ul><li>Provides <a href=https://docs.rke2.io/security/hardening_guide target=_blank>defaults and configuration options</a> that allow clusters to pass the CIS Kubernetes Benchmark <a href=https://docs.rke2.io/security/cis_self_assessment17 target=_blank>v1.7</a> or <a href=https://docs.rke2.io/security/cis_self_assessment18 target=_blank>v1.8</a> with minimal operator intervention</li><li>Enables <a href=https://docs.rke2.io/security/fips_support target=_blank>FIPS 140-2 compliance</a></li><li>Regularly scans components for CVEs using <a href=https://github.com/aquasecurity/trivy target=_blank>trivy</a> in our build pipeline</li></ul><h3 class="relative group">How is this different from RKE or K3s?<div id=how-is-this-different-from-rke-or-k3s class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#how-is-this-different-from-rke-or-k3s aria-label=Anchor>#</a></span></h3><p>RKE2 combines the best of RKE1 and K3s.</p><p>From K3s, it inherits usability, ease of operation, and a simple deployment model. From RKE1, it inherits close alignment with upstream Kubernetes. Where K3s diverged from upstream to optimize for edge deployments, RKE2 stays closely aligned.</p><p>Importantly, <strong>RKE2 does not rely on Docker</strong> as RKE1 does. RKE1 used Docker to deploy control plane components. RKE2 launches control plane components as static pods, managed by the kubelet, and uses <strong>containerd</strong> as its embedded container runtime.</p><h3 class="relative group">RKE2 Architecture<div id=rke2-architecture class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#rke2-architecture aria-label=Anchor>#</a></span></h3><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/zHVzDVz1/image.png></figure><em>Image from RKE2 offical docs</em></p><p>RKE2 brings together several Open Source technologies to make this work:</p><ul><li><strong><a href=https://kubernetes.io/ target=_blank>K8s</a></strong><ul><li><strong><a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/ target=_blank>API Server</a></strong>: The central hub. All cluster communication goes through here.</li><li><strong><a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/ target=_blank>Scheduler</a></strong>: Decides which node a new pod should run on.</li><li><strong><a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/ target=_blank>Controller Manager</a></strong>: The &ldquo;thermostat.&rdquo; Works to make the <em>actual</em> state match the <em>desired</em> state (e.g., &ldquo;I need 3 pods&rdquo;).</li><li><strong><a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/ target=_blank>Kubelet</a></strong>: The agent on each node. Takes orders from the API Server and tells <code>containerd</code> what to do.</li><li><strong><a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/ target=_blank>Proxy</a></strong>: A network proxy on each node that manages virtual IPs for services.</li></ul></li><li><strong><a href=https://etcd.io/ target=_blank>etcd</a></strong>: The cluster&rsquo;s database. Stores the &ldquo;desired state&rdquo; of everything.</li><li><strong><a href=https://coredns.io/ target=_blank>CoreDNS</a></strong>: The internal DNS server for the cluster.</li><li><strong><a href=https://github.com/kubernetes/cri-api target=_blank>cri</a></strong>: An API that lets <code>kubelet</code> talk to different container runtimes.</li><li><strong><a href=https://containerd.io/ target=_blank>containerd</a></strong>: The container runtime that manages the complete container lifecycle.</li><li><strong><a href=https://github.com/opencontainers/runc target=_blank>runc</a></strong>: The low-level tool that actually creates and runs the containers</li><li><strong><a href=https://github.com/containernetworking/cni target=_blank>CNI</a></strong>: The plugin system for pod networking (RKE2 uses <code>canal</code> by default).</li><li><strong><a href=https://traefik.io/traefik target=_blank>Traefik</a></strong>: The default Ingress controller (routes external traffic <em>into</em> the cluster).</li><li><strong><a href=https://github.com/kubernetes-sigs/metrics-server target=_blank>Metrics Server</a></strong>: Collects resource usage data (CPU/RAM).</li><li><strong><a href=https://helm.sh/ target=_blank>Helm</a> & <a href=https://github.com/k3s-io/helm-controller target=_blank>Helm Controller</a></strong>: A package manager. The <code>helm-controller</code> can automatically apply any charts found in <code>/var/lib/rancher/rke2/server/manifests</code>.</li></ul><h3 class="relative group">A 30-Second Kubernetes Refresher<div id=a-30-second-kubernetes-refresher class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#a-30-second-kubernetes-refresher aria-label=Anchor>#</a></span></h3><p>To understand Kubernetes objects broadly, here&rsquo;s a concise table:</p><table><thead><tr><th><strong>Category</strong></th><th><strong>Object</strong></th><th><strong>Purpose & Explanation</strong></th></tr></thead><tbody><tr><td><strong>Workloads</strong></td><td><strong>Pod</strong></td><td><strong>The smallest deployable unit.</strong> Holds one or more containers that share a network and storage.</td></tr><tr><td>(Objects that run or manage containers)</td><td><strong>ReplicaSet</strong></td><td><strong>Ensures a specific number (&ldquo;X&rdquo;) of identical pods</strong> are always running. (You rarely use this directly).</td></tr><tr><td></td><td><strong>Deployment</strong></td><td><strong>Manages the lifecycle of stateless apps.</strong> Defines a desired state and manages rolling updates via ReplicaSets.</td></tr><tr><td></td><td><strong>StatefulSet</strong></td><td><strong>Manages stateful apps (like databases)</strong> by giving each pod a stable, unique identity (e.g., <code>db-0</code>) and storage.</td></tr><tr><td></td><td><strong>DaemonSet</strong></td><td><strong>Ensures one pod runs on every (or specific) node,</strong> typically for node-level agents like logging or monitoring.</td></tr><tr><td></td><td><strong>Job</strong></td><td><strong>Runs a one-time task to completion</strong> by creating pods that run once and then stop.</td></tr><tr><td></td><td><strong>CronJob</strong></td><td><strong>Runs a Job on a schedule</strong> (e.g., a nightly backup).</td></tr><tr><td><strong>Networking</strong></td><td><strong>Service</strong></td><td><strong>Provides a stable network endpoint (IP/name)</strong> for a group of pods, acting as an internal load balancer and for service discovery.</td></tr><tr><td><strong>Storage</strong></td><td><strong>PersistentVolume (PV)</strong></td><td><strong>The actual &ldquo;supply&rdquo; of storage</strong> (e.g., a cloud disk) made available to the cluster by an administrator.</td></tr><tr><td></td><td><strong>PersistentVolumeClaim (PVC)</strong></td><td><strong>A user&rsquo;s &ldquo;request&rdquo; for storage</strong> that claims an available PersistentVolume (PV).</td></tr><tr><td><strong>Configuration</strong></td><td><strong>ConfigMap</strong></td><td><strong>Stores non-sensitive configuration data</strong> (like config files or env variables) as key-value pairs to inject into pods.</td></tr><tr><td></td><td><strong>Secret</strong></td><td><strong>Stores sensitive data</strong> (like passwords, API keys, or certificates) securely, to be injected into pods.</td></tr><tr><td><strong>Organization</strong></td><td><strong>Namespace</strong></td><td><strong>A &ldquo;virtual cluster&rdquo; that isolates resources</strong> between different teams, projects, or environments (e.g., <code>dev</code>, <code>prod</code>).</td></tr></tbody></table><p>To sum up how all of that comes into play, here&rsquo;s a nice diagram of how a pod is created, drawn by <a href=https://belowthemalt.com/2022/04/08/kubernetes-cluster-process-flow-of-a-pod-creation/ target=_blank>rajeshsgr</a>.<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/JMvdXCL/image.png></figure></p><p>After introducing RKE2 and some basic Kubernetes knowledge, let&rsquo;s move on to deploying it with Ansible.</p><h2 class="relative group">The Elephant in the Room: Terraform vs. Ansible<div id=the-elephant-in-the-room-terraform-vs-ansible class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-elephant-in-the-room-terraform-vs-ansible aria-label=Anchor>#</a></span></h2><p>Alright, let&rsquo;s address the big elephant in the room. &ldquo;I already have one powerful automation tool like Terraform, why on earth would I add another tool like Ansible?&rdquo;</p><p>It&rsquo;s a fair question. Both are &ldquo;Infrastructure as Code,&rdquo; right? You could say that, but they don&rsquo;t solve the same core problem. The classic analogy is: <strong><code>Terraform</code> builds the house, and <code>Ansible</code> furnishes it.</strong> You need both because they are masters of two different domains: provisioning and configuration.</p><p>Let&rsquo;s be clear on what Terraform rocks at. It&rsquo;s brilliant at creating, updating, and destroying the &ldquo;metal.&rdquo; But once that server is &ldquo;on,&rdquo; Terraform&rsquo;s job is pretty much done. <em>Don&rsquo;t</em> attempt to use it for configuration. Sure, you <em>can</em> use <code>remote-exec</code> provisioners to run shell scripts. But it&rsquo;s awful, hard to debug, and if it fails, Terraform might &ldquo;taint&rdquo; the resource and want to destroy it. It has no logic for &ldquo;rolling updates&rdquo; or complex app deployments.</p><p>This is where Ansible steps in. Ansible is an <strong>automation and configuration management</strong> tool. Its job is to take the servers Terraform built and make them <em>do something useful</em>. Ansible is (mostly) <strong>procedural</strong>. You write a <strong>Playbook</strong> (in simple YAML) that lists a set of tasks to run, in order. It&rsquo;s <strong>agentless</strong> (it just uses SSH) and it doesn&rsquo;t care about &ldquo;state&rdquo; in the same way Terraform does. It just runs your tasks.Terraform does. It just runs your tasks.</p><h2 class="relative group">My Automation Workflow: From Terraform to Ansible<div id=my-automation-workflow-from-terraform-to-ansible class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#my-automation-workflow-from-terraform-to-ansible aria-label=Anchor>#</a></span></h2><p>Therefore, the best practice is to combine both tools. The workflow to deploy the Kubernetes cluster on Proxmox looks like this:</p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/spY06yv4/image.png></figure><h3 class="relative group">Phase 1: Terraform Builds the House (Covered in Part 4)<div id=phase-1-terraform-builds-the-house-covered-in-part-4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#phase-1-terraform-builds-the-house-covered-in-part-4 aria-label=Anchor>#</a></span></h3><ul><li><p>Download a cloud-init-ready image.</p></li><li><p>Define specs (CPU, memory, disk).</p></li><li><p>Use <code>cloud-init</code> to set the static IP and inject your public SSH key.</p></li><li><p>Create the VMs (three types: <code>servers</code>, <code>agents</code>, <code>longhorn</code> nodes). <code>servers</code> are for the control plane, <code>agents</code> are worker nodes, and <code>longhorn</code> nodes are worker nodes configured with lots of storage to act as our high-availability persistent storage.</p></li></ul><h3 class="relative group">The Handoff: Our &ldquo;Terraform-to-Ansible&rdquo; Glue<div id=the-handoff-our-terraform-to-ansible-glue class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-handoff-our-terraform-to-ansible-glue aria-label=Anchor>#</a></span></h3><p>This is the glue. My <code>k8s_nodes.json</code> file from Terraform is our &ldquo;source of truth.&rdquo; I run a simple script that parses that JSON and auto-generates the <code>inventory/hosts.ini</code> file that Ansible needs. This means if I add a node in Terraform, it automatically gets configured by Ansible on the next run.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./scripts/generate-all-hosts.sh dev
</span></span></code></pre></div><p>I also run a cleanup script to clear old SSH keys, which prevents &ldquo;host key&rdquo; errors:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./scripts/clean-up-ssh-known-hosts.sh dev
</span></span></code></pre></div><h3 class="relative group">Phase 2: Ansible Furnishes the House<div id=phase-2-ansible-furnishes-the-house class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#phase-2-ansible-furnishes-the-house aria-label=Anchor>#</a></span></h3><ul><li><p><strong>Prepare</strong> all nodes (enable IP forwarding, create directories) & <strong>Download</strong> RKE2.</p></li><li><p><strong>Bootstrap</strong> RKE2 on the <code>servers</code> nodes.</p></li><li><p><strong>Join</strong> the <code>agents</code> and <code>longhorn</code> nodes to the cluster.</p></li><li><p><strong>Deploy kube-vip</strong> for a high-availability VIP for the <code>servers</code> and to provide LoadBalancer IPs for <code>Services</code>.</p></li><li><p><strong>Deploy cert-manager & traefik</strong> for SSL certificates and an ingress controller.</p></li><li><p><strong>Deploy longhorn</strong> for high-availability persistent storage.</p></li><li><p><strong>Deploy argo-cd</strong> for GitOps deployment of all our applications (covered in the next part).</p></li><li><p><strong>Fetch</strong> the <code>kubectl</code> config from the server to our local machine.</p></li></ul><p>Here&rsquo;s the overview of my Ansible structure based on that workflow. <code>ansible.cfg</code> sets default CLI arguments. <code>collections/requirements.yaml</code> lists required Ansible plugins. The <code>inventory</code> directory stores our variables (like the VM IPs). <code>site.yaml</code> is the main playbook that calls the modular playbooks (Roles) located in the <code>roles</code> directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── ansible.cfg
</span></span><span class=line><span class=cl>├── collections
</span></span><span class=line><span class=cl>│   └── requirements.yaml
</span></span><span class=line><span class=cl>├── inventory
</span></span><span class=line><span class=cl>│   ├── group_vars
</span></span><span class=line><span class=cl>│   └── hosts.ini
</span></span><span class=line><span class=cl>├── roles
</span></span><span class=line><span class=cl>│   ├── add-agent
</span></span><span class=line><span class=cl>│   ├── add-server
</span></span><span class=line><span class=cl>│   ├── apply-argocd
</span></span><span class=line><span class=cl>│   ├── apply-kube-vip
</span></span><span class=line><span class=cl>│   ├── apply-longhorn
</span></span><span class=line><span class=cl>│   ├── apply-ssl
</span></span><span class=line><span class=cl>│   └── download-rke2
</span></span><span class=line><span class=cl>└── site.yaml
</span></span></code></pre></div><h2 class="relative group">Setting the Stage: Ansible Inventory and Variables<div id=setting-the-stage-ansible-inventory-and-variables class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#setting-the-stage-ansible-inventory-and-variables aria-label=Anchor>#</a></span></h2><p>As introduced above, here&rsquo;s the <code>inventory/hosts.ini</code> file. It contains the IPs of the machines that Ansible will target. Notice it has three categories (<code>agents</code>, <code>longhorn</code>, <code>servers</code>) and one big group-of-groups: <code>rke2:children</code>. This is needed to specify whether a task should run on a specific group or on <em>all</em> machines. This file is auto-generated by the script in the handoff phase.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[agents]</span>
</span></span><span class=line><span class=cl><span class=na>dev-agent1 ansible_host</span><span class=o>=</span><span class=s>10.69.1.181</span>
</span></span><span class=line><span class=cl><span class=na>dev-agent2 ansible_host</span><span class=o>=</span><span class=s>10.69.1.182</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[longhorn]</span>
</span></span><span class=line><span class=cl><span class=na>dev-longhorn1 ansible_host</span><span class=o>=</span><span class=s>10.69.1.114</span>
</span></span><span class=line><span class=cl><span class=na>dev-longhorn2 ansible_host</span><span class=o>=</span><span class=s>10.69.1.115</span>
</span></span><span class=line><span class=cl><span class=na>dev-longhorn3 ansible_host</span><span class=o>=</span><span class=s>10.69.1.116</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[servers]</span>
</span></span><span class=line><span class=cl><span class=na>dev-server1 ansible_host</span><span class=o>=</span><span class=s>10.69.1.111</span>
</span></span><span class=line><span class=cl><span class=na>dev-server2 ansible_host</span><span class=o>=</span><span class=s>10.69.1.112</span>
</span></span><span class=line><span class=cl><span class=na>dev-server3 ansible_host</span><span class=o>=</span><span class=s>10.69.1.113</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[rke2:children]</span>
</span></span><span class=line><span class=cl><span class=na>agents</span>
</span></span><span class=line><span class=cl><span class=na>longhorn</span>
</span></span><span class=line><span class=cl><span class=na>servers</span>
</span></span></code></pre></div><p>Additionally, <code>inventory/group_vars/all.yaml</code> is our main variables config file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>ansible_user</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rke2_version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;v1.32.3+rke2r1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>arch</span><span class=p>:</span><span class=w> </span><span class=l>amd64</span><span class=w> </span><span class=c># type of machine, raspberry pi use arm64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rke2_token</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w> </span><span class=c># for authenticate &amp; add nodes in cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>vip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.69.1.110&#34;</span><span class=w> </span><span class=c># for virtual ip of the servers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>vip_cidr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;16&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>vip_lb_range</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.69.1.117-10.69.1.119&#34;</span><span class=w> </span><span class=c># load balancer ip range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ssl_local_domain</span><span class=p>:</span><span class=w> </span><span class=l>dev.phuchoang.sbs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ssl_cloudflare_api_token</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ssl_email</span><span class=p>:</span><span class=w> </span><span class=l>xuanphuc.a1gv@gmail.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ssl_ingress_ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.69.1.117&#34;</span><span class=w> </span><span class=c># default traefik ip, must be in the range above</span><span class=w>
</span></span></span></code></pre></div><h2 class="relative group">The Master Plan: Our site.yaml Playbook<div id=the-master-plan-our-siteyaml-playbook class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-master-plan-our-siteyaml-playbook aria-label=Anchor>#</a></span></h2><p>As introduced earlier, <code>site.yaml</code> is the master playbook that calls the child roles. It sources the tasks from <code>roles/&lt;role_name>/tasks/main.yaml</code>. Here&rsquo;s the overview of my <code>site.yaml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Prepare all nodes &amp; Download RKE2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>rke2</span><span class=w> </span><span class=c># servers + agents + longhorn nodes combined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>download-rke2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Bootstrap k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Bootstrap RKE2 Servers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>servers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>add-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Add additional RKE2 agents &amp; longhorn agents</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>agents, longhorn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>add-agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Deploy applications</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy Kube VIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>servers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>apply-kube-vip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>kube_vip]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy Cert-Manager &amp; Traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>servers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>apply-ssl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>ssl]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy Optional services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>servers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>apply-longhorn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>longhorn]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>apply-argocd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>argocd]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Fetch kubeconfig from the first server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>servers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Fetch kubeconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.fetch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/home/{{ ansible_user }}/.kube/config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/{{ env }}.yaml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>flat</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>inventory_hostname == groups[&#39;servers&#39;][0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Configure kubectl on localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>connection</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Ensure .kube directory exists on localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;env&#39;, &#39;HOME&#39;) }}/.kube&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0755&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Move fetched kubeconfig to ~/.kube/{{env}}.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mv /tmp/{{ env }}.yaml {{ lookup(&#39;env&#39;, &#39;HOME&#39;) }}/.kube/{{env}}.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Rename context from &#39;default&#39; to a unique name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.replace</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;env&#39;, &#39;HOME&#39;) }}/.kube/{{env}}.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>regexp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;default&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>replace</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{env}}&#34;</span><span class=w>
</span></span></span></code></pre></div><h2 class="relative group">The Playbook in Action: A Step-by-Step Breakdown<div id=the-playbook-in-action-a-step-by-step-breakdown class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-playbook-in-action-a-step-by-step-breakdown aria-label=Anchor>#</a></span></h2><h3 class="relative group">1. Prepare All Nodes & Download RKE2<div id=1-prepare-all-nodes--download-rke2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#1-prepare-all-nodes--download-rke2 aria-label=Anchor>#</a></span></h3><p>This role prepares each node for RKE2 by configuring node-level prerequisites and placing the RKE2 binary on the system. It runs on <em>all</em> nodes (servers and agents) and performs the following tasks:</p><ul><li><strong>Disable Swap</strong>: Ensures swap is disabled, a prerequisite for the Kubelet (<a href=https://discuss.kubernetes.io/t/swap-off-why-is-it-necessary/6879 target=_blank>source</a>).</li><li><strong>Enable IP Forwarding</strong>: Enables IPv4 and IPv6 packet forwarding via <code>sysctl</code>, a networking requirement for all CNI plugins (<a href=https://www.reddit.com/r/kubernetes/comments/ha97dn/does_ip_forwarding_have_to_be_enabled_to_run_k8s/ target=_blank>source</a>).</li><li><strong>Create Install Directory</strong>: Ensures the target directory for the binary (e.g., <code>/usr/local/bin</code>) exists.</li><li><strong>Download RKE2 Binary</strong>: Downloads the specific RKE2 version defined in your variables.</li><li><strong>Set Permissions</strong>: Makes the downloaded RKE2 binary executable.</li><li><strong>Create Server-Specific Directories</strong>: On <code>servers</code> only, it pre-creates the directories for RKE2 manifests (<code>/var/lib/rancher/rke2/server/manifests</code> for <code>Helm Controller</code> deployment) and configuration (<code>/etc/rancher/rke2</code>).</li></ul><h3 class="relative group">2. Bootstrapping the Control Plane (add-server)<div id=2-bootstrapping-the-control-plane-add-server class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#2-bootstrapping-the-control-plane-add-server aria-label=Anchor>#</a></span></h3><p>This role targets only the <code>servers</code> group to configure and start the RKE2 server components, forming the control plane. This role includes:</p><ul><li><strong>Create Configuration Directory</strong>: Ensures <code>/etc/rancher/rke2/</code> exists.</li><li><strong>Deploy Server Configuration</strong>: Deploys a <code>config.yaml</code> file from a template. This file dynamically populates key settings:<ul><li><code>token</code>: The shared secret for the cluster.</li><li><code>tls-san</code>: A list of Subject Alternative Names for the API server&rsquo;s TLS certificate, including the node&rsquo;s IP, hostname, and the shared Virtual IP (<code>vip</code>).</li><li><strong>Conditional Logic</strong>: The role intelligently detects if it&rsquo;s configuring the <em>first</em> server or a <em>joining</em> server. For joining servers, it adds the <code>server</code> URL to the config so the new node knows how to connect to the existing cluster.</li></ul></li><li><strong>Enable and Start RKE2 Server</strong>: Enables and starts the <code>rke2-server.service</code>.</li><li><strong>Deploy CoreDNS Config (First Server Only)</strong>: On the first server, it deploys a custom CoreDNS configuration. (Thanks to the <code>Helm Controller</code>, this will be automatically applied to the cluster).</li><li><strong>Create Kubeconfig</strong>: It waits for the server to be ready and then creates a <code>.kube/config</code> file in the remote user&rsquo;s home directory.</li></ul><p>The main logic is in <code>roles/add-server/tasks/main.yaml</code>, and the Jinja template that injects the variables is at <code>roles/add-server/templates/rke2-server-config.j2</code>. You can see I&rsquo;ve disabled certain things (like <code>rke2-ingress-nginx</code>) to make it more lightweight and replace them with my own (Traefik).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>write-kubeconfig-mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0644&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>token</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>rke2_token }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># server: https://{{ hostvars[groups[&#39;servers&#39;][0]][&#39;ansible_host&#39;] }}:9345 // for join node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tls-san</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {{<span class=w> </span><span class=l>vip }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{<span class=l>% for host in groups[&#39;servers&#39;] %}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {{<span class=w> </span><span class=l>hostvars[host][&#39;ansible_host&#39;] }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{<span class=l>% endfor %}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>node-label</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>server=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>disable-cloud-controller</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>disable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>rke2-ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kube-proxy-arg</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;proxy-mode=ipvs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;ipvs-strict-arp=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kube-proxy-extra-mount</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=s2>&#34;/lib/modules:/lib/modules:ro&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">3. Joining the Worker Nodes (add-agent)<div id=3-joining-the-worker-nodes-add-agent class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#3-joining-the-worker-nodes-add-agent aria-label=Anchor>#</a></span></h3><p>This role targets all hosts in the <code>agents</code> and <code>longhorn</code> groups, configuring them as worker nodes and joining them to the cluster.</p><ul><li><strong>Create Configuration Directory</strong>: Ensures <code>/etc/rancher/rke2/</code> exists.</li><li><strong>Create Systemd Service</strong>: Generates the <code>rke2-agent.service</code> systemd file from a template.</li><li><strong>Deploy Agent Configuration</strong>: Deploys a <code>config.yaml</code> file templated with the server URL (pointing to the first master) and the cluster token. It also includes specific settings for the <code>longhorn</code> group so that when we deploy Longhorn later, it knows which nodes it should run on.</li><li><strong>Enable and Start RKE2 Agent</strong>: Enables and starts the <code>rke2-agent.service</code>, which connects to the control plane.</li></ul><p>Here&rsquo;s the agent config template. Notice in the <code>node-label</code> section, you can add a label for Longhorn nodes, this will be useful later when we deploy Longhorn.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>write-kubeconfig-mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0644&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>token</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>rke2_token }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://{{ hostvars[groups[&#39;servers&#39;][0]][&#39;ansible_host&#39;] }}:9345</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>node-label</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;agent=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  - &#34;node.longhorn.io/create-default-disk=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kube-proxy-arg</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;proxy-mode=ipvs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;ipvs-strict-arp=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kube-proxy-extra-mount</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=s2>&#34;/lib/modules:/lib/modules:ro&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">4. High Availability with Kube-VIP<div id=4-high-availability-with-kube-vip class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#4-high-availability-with-kube-vip aria-label=Anchor>#</a></span></h3><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/gQ5VKxH/image.png></figure><em>Image from <a href=https://www.sobyte.net/post/2021-09/use-kube-vip-ha-k8s-lb/ target=_blank>https://www.sobyte.net/post/2021-09/use-kube-vip-ha-k8s-lb/</a></em></p><p>This role sets up a virtual IP (VIP) to create a highly available endpoint for the Kubernetes API server. <code>kube-vip</code> provides VIP and load balancing for bare-metal clusters. For control plane HA, it ensures continuous access to the API Server if a node fails. Additionally, it provides a native, in-cluster load balancer solution, giving us <code>Service</code> objects of type <code>LoadBalancer</code> without needing an external cloud provider.</p><p>This playbook performs the following tasks:</p><ul><li><p><strong>Deploy RBAC Rules</strong>: Deploys a template to create the necessary <code>ClusterRole</code> and <code>ClusterRoleBinding</code> for Kube VIP.</p></li><li><p><strong>Deploy Kube VIP ConfigMap</strong>: Deploys a <code>ConfigMap</code> that configures the virtual IP address.</p></li><li><p><strong>Deploy Kube VIP Cloud Controller</strong>: Deploys a template that creates a <code>DaemonSet</code> (to run Kube VIP on every control-plane node) and the cloud controller (to provide <code>LoadBalancer</code> services).</p></li></ul><p>Remember when I mentioned the <code>Helm Controller</code> that RKE2 integrated? This makes deploying manifests easy. Any file found in <code>/var/lib/rancher/rke2/server/manifests</code> will automatically be deployed, similar to <code>kubectl apply</code>. However, this method isn&rsquo;t always reliable, as it&rsquo;s hard to debug and track what went wrong (as you&rsquo;ll see in the next section). Therefore, I&rsquo;ve chosen <strong>ArgoCD</strong> to deploy all my applications later.</p><h3 class="relative group">5. Ingress and SSL with Traefik & Cert-Manager<div id=5-ingress-and-ssl-with-traefik--cert-manager class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#5-ingress-and-ssl-with-traefik--cert-manager aria-label=Anchor>#</a></span></h3><p>I didn&rsquo;t want to access services via <code>NodePort</code> and port-forwarding. I figured I&rsquo;d configure <code>LoadBalancer</code> services, since I already have <code>kube-vip</code>. However, I also don&rsquo;t like remembering IPs for each service, so I thought I&rsquo;d use an Ingress Controller.</p><blockquote><p>I need to be honest: this part was a nightmare, and I want to share the solutions so you don&rsquo;t waste a day like I did.</p><ul><li><p><strong>Problem 1 (Silent Fail):</strong> RKE2&rsquo;s Helm controller <em>silently</em> failed because I forgot to rename my <code>cert-manager-helm-chart.j2</code> file to <code>.yaml</code>.</p></li><li><p><strong>Problem 2 (Fetch Fail):</strong> When it finally loaded, the HelmChart couldn&rsquo;t fetch the cert-manager repo. The logs were useless.</p></li><li><p><strong>Solution 2:</strong> I had to download the <code>.tgz</code> file, <strong>base64 encode it</strong>, and manually inject it into the <code>chartContent</code> field of the manifest just to see the <em>real</em> error.</p></li><li><p><strong>Problem 3 (DNS Fail):</strong> The <em>real</em> error was that DNS-01 validation was failing. My VM&rsquo;s default DNS (<code>/etc/resolv.conf</code>) was pointing to my internal router, which couldn&rsquo;t resolve the Let&rsquo;s Encrypt validation domains.</p></li><li><p><strong>The Fix:</strong> I had to go all the way back to <strong>Terraform</strong> and specify an external DNS server (like <code>1.1.1.1</code>) in my <code>cloud-init</code> config. I&rsquo;m still not 100% sure why this was the only fix, but it worked.</p></li></ul></blockquote><p>Eventually, I circled back to <strong>Traefik</strong>—mainly because I’m planning to integrate Authentik for authentication, and Traefik&rsquo;s middlewares make that much easier. This role performs the following tasks:</p><ul><li><strong>Deploy Cert-Manager</strong>: Deploys the Cert-Manager Helm chart to automate TLS certificates.</li><li><strong>Deploy ClusterIssuer</strong>: Deploys a <code>ClusterIssuer</code> custom resource. This configures Cert-Manager with my Cloudflare API token and email to issue certificates.</li><li><strong>Deploy Traefik</strong>: Deploys the Helm chart for Traefik, our ingress controller.figured with your specified values.</li></ul><p>The most important part here is the <code>ClusterIssuer</code>, which authenticates with Cloudflare using the variables from our <code>all.yaml</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-api-token-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>cert-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>stringData</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>api-token</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>ssl_cloudflare_api_token }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert-manager.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIssuer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-clusterissuer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>acme</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>email</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>ssl_email }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://acme-v02.api.letsencrypt.org./directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>privateKeySecretRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>solvers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>dns01</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cloudflare</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>apiTokenSecretRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-api-token-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>api-token</span><span class=w>
</span></span></span></code></pre></div><p>After that, you need to configure Traefik to <em>use</em> this issuer to generate wildcard certificates. This means any service I create at <code>*.dev.phuchoang.sbs</code> will get SSL automatically.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert-manager.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Certificate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>wildcard-cert</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>wildcard-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;{{ ssl_local_domain }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;*.{{ ssl_local_domain }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>issuerRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-clusterissuer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIssuer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>privateKey</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rotationPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>additionalOutputFormats</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>CombinedPEM</span><span class=w>
</span></span></span></code></pre></div><h3 class="relative group">6. Deploying Core Services (Longhorn & ArgoCD)<div id=6-deploying-core-services-longhorn--argocd class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#6-deploying-core-services-longhorn--argocd aria-label=Anchor>#</a></span></h3><h4 class="relative group">Longhorn: For Persistent, Replicated Storage<div id=longhorn-for-persistent-replicated-storage class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#longhorn-for-persistent-replicated-storage aria-label=Anchor>#</a></span></h4><ul><li><strong>Longhorn</strong> is a lightweight, distributed block storage system for Kubernetes. It provides persistent storage for stateful applications, replicates that storage for high availability, and can back up volumes to our TrueNAS NFS server.</li><li>We install Longhorn on the nodes we tagged with the <code>node.longhorn.io/create-default-disk=true</code> label back in the <code>add-agent</code> role.</li><li>However, Longhorn has several prerequisites, including <code>open-iscsi</code> and an <code>nfsv4</code> client. When I used the Longhorn CLI tool to check my nodes, I found I was missing them. Luckily, Longhorn offers manifest jobs to install these dependencies, so I deploy those first, then the Longhorn Helm chart, and finally an <code>IngressRoute</code> to expose its UI.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy longhorn iscsi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ansible.builtin.template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>templates/longhorn-iscsi.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/rancher/rke2/server/manifests/longhorn-iscsi.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0644&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>inventory_hostname == groups[&#39;servers&#39;][0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy longhorn nfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ansible.builtin.template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>templates/longhorn-nfs.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/rancher/rke2/server/manifests/longhorn-nfs.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0644&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>inventory_hostname == groups[&#39;servers&#39;][0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy longhorn-helm-chart manifest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ansible.builtin.template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>templates/longhorn-helm-chart.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/rancher/rke2/server/manifests/longhorn-helm-chart.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0644&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>inventory_hostname == groups[&#39;servers&#39;][0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy longhorn-ingress-route.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ansible.builtin.template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>templates/longhorn-ingress-route.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/rancher/rke2/server/manifests/longhorn-ingress-route.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0644&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>inventory_hostname == groups[&#39;servers&#39;][0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ssl</span><span class=w>
</span></span></span></code></pre></div><h4 class="relative group">ArgoCD: Our GitOps Engine<div id=argocd-our-gitops-engine class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#argocd-our-gitops-engine aria-label=Anchor>#</a></span></h4><ul><li>ArgoCD will play a prominent role in the cluster, as it will be responsible for deploying <em>all</em> of our applications in the next part of the series.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy argocd-helm-chart.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ansible.builtin.template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>templates/argocd-helm-chart.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/rancher/rke2/server/manifests/argocd-helm-chart.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0644&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>inventory_hostname == groups[&#39;servers&#39;][0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy argocd-ingress-route.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ansible.builtin.template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>templates/argocd-ingress-route.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/rancher/rke2/server/manifests/argocd-ingress-route.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_user }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0644&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>inventory_hostname == groups[&#39;servers&#39;][0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ssl</span><span class=w>
</span></span></span></code></pre></div><h2 class="relative group">The Final Handoff: Getting kubectl Access<div id=the-final-handoff-getting-kubectl-access class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-final-handoff-getting-kubectl-access aria-label=Anchor>#</a></span></h2><p>After all those tasks, we finally have a fully-fledged, working Kubernetes cluster. The last step is to get the cluster&rsquo;s configuration file onto our local machine so we can control it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Fetch kubeconfig from the first server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>servers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Fetch kubeconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.fetch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/home/{{ ansible_user }}/.kube/config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/{{ env }}.yaml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>flat</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>inventory_hostname == groups[&#39;servers&#39;][0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Configure kubectl on localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>connection</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Ensure .kube directory exists on localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;env&#39;, &#39;HOME&#39;) }}/.kube&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0755&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Move fetched kubeconfig to ~/.kube/{{env}}.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mv /tmp/{{ env }}.yaml {{ lookup(&#39;env&#39;, &#39;HOME&#39;) }}/.kube/{{env}}.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Rename context from &#39;default&#39; to a unique name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.replace</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;env&#39;, &#39;HOME&#39;) }}/.kube/{{env}}.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>regexp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;default&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>replace</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{env}}&#34;</span><span class=w>
</span></span></span></code></pre></div><h2 class="relative group">Verification<div id=verification class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#verification aria-label=Anchor>#</a></span></h2><p>You might want to set this environment variable in your <code>.bashrc</code> or shell config so <code>kubectl</code> auto-detects all your config files. This is my nushell config, for example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$env.KUBECONFIG = (glob &#39;~/.kube/*.yml&#39; | str join &#39;:&#39;)</span><span class=w>
</span></span></span></code></pre></div><p>After that, use <code>kubectx</code> and <code>kubens</code> (highly recommended tools) to switch your context and namespace. Then, verify the nodes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>dev <span class=o>(</span>default<span class=o>)</span> in kubernetes-proxmox on  master <span class=o>[</span>!<span class=o>]</span> is 📦 v0.1.0 via 🐍 v3.13.7
</span></span><span class=line><span class=cl>❯ k get nodes
</span></span><span class=line><span class=cl>NAME            STATUS   ROLES                       AGE    VERSION
</span></span><span class=line><span class=cl>dev-longhorn1   Ready    &lt;none&gt;                      2d3h   v1.32.3+rke2r1
</span></span><span class=line><span class=cl>dev-longhorn2   Ready    &lt;none&gt;                      2d3h   v1.32.3+rke2r1
</span></span><span class=line><span class=cl>dev-longhorn3   Ready    &lt;none&gt;                      2d3h   v1.32.3+rke2r1
</span></span><span class=line><span class=cl>dev-server1     Ready    control-plane,etcd,master   2d3h   v1.32.3+rke2r1
</span></span><span class=line><span class=cl>dev-server2     Ready    control-plane,etcd,master   2d3h   v1.32.3+rke2r1
</span></span><span class=line><span class=cl>dev-server3     Ready    control-plane,etcd,master   2d3h   v1.32.3+rke2r1
</span></span></code></pre></div><h2 class="relative group">Summary & Next Steps<div id=summary--next-steps class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#summary--next-steps aria-label=Anchor>#</a></span></h2><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt src=https://i.ibb.co/svKZZvyy/image.png></figure><p>And just like that, we have a fully-fledged, highly-available Kubernetes cluster.</p><p>Thanks to Terraform, we can destroy and rebuild these 12 VMs in minutes. And thanks to Ansible, we can configure them all from scratch with a single command (<code>ansible-playbook site.yaml</code>).</p><p>We now have:</p><ul><li>A multi-master <code>RKE2</code> control plane</li><li>A Virtual IP for HA with <code>kube-vip</code></li><li>An ingress controller (<code>Traefik</code>)</li><li>Automatic SSL certificates (<code>cert-manager</code>)</li><li>Distributed persistent storage (<code>Longhorn</code>)</li></ul><p>The cluster is built. The platform is ready. In the next and final part of this series, we&rsquo;ll do the fun stuff: <strong>use <code>ArgoCD</code> to deploy all of our applications</strong> with a true GitOps workflow.</p></div><details class="mt-2 mb-5 overflow-hidden rounded-lg ms-0 ps-5"><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 -ms-5 ps-5 dark:bg-primary-800 dark:text-neutral-100">On-Premise 101 -
This article is part of a series.</summary><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/112/posts/on-premise-hardware/>Part 1:
On-Premise 101 (Part 1): Building a 3-Node Cluster</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/112/posts/on-premise-hypervisor/>Part 2:
On-Premise 101 (Part 2): Proxmox, the "Glue" for My Homelab</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/112/posts/on-premise-storage/>Part 3:
On-Premise 101 (Part 3): My "Fearless" NAS Build with Virtualized TrueNAS, ZFS, and Cloud Backups</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/previews/112/posts/on-premise-provision-terraform/>Part 4:
On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">Part 5:
This Article</div></details><h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><article class="relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src=/previews/112/image_13430388991849673189_hu_d7d3b8931768c3d0.png alt="On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform" loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class="px-6 py-4"><header><a href=/previews/112/posts/on-premise-provision-terraform/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-11-06T00:00:00+00:00>6 November 2025</time><span class="px-2 text-primary-500">&#183;</span><span>2969 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">14 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/on-premise-provision-terraform.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span>
</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/on-premise-provision-terraform.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full -mt-[2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/terraform/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Terraform
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/proxmox/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Proxmox
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/kubernetes/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/cloud/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cloud</span></span></a></div></div><div class="prose dark:prose-invert py-1">I&rsquo;m the kind of person who will happily spend 10 hours building an automation script just to save 10 minutes of manual work every day. If that sounds like you, you&rsquo;re in the right place.</div></div><div class="px-6 pt-4 pb-2"></div></article><article class="relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src=/previews/112/image_11647519231104458962_hu_33f4d45946002114.png alt="Automate provisioning Kubernetes cluster on Proxmox with Terraform + Ansible" loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class="px-6 py-4"><header><a href=https://github.com/phuchoang2603/kubernetes-proxmox target=_blank rel=external class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Automate provisioning Kubernetes cluster on Proxmox with Terraform + Ansible
<span class="cursor-default align-top text-xs text-neutral-400 dark:text-neutral-500"><span class=rtl:hidden>&#8599;</span>
<span class=ltr:hidden>&#8598;</span></span></h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-05-31T00:00:00+00:00>31 May 2025</time></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/kubernetes/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/proxmox/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Proxmox
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/terraform/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Terraform
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/ansible/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Ansible</span></span></a></div></div><div class="prose dark:prose-invert py-1">This project automates the provisioning and configuration of a RKE2 Kubernetes cluster on Proxmox using Terraform and Ansible.</div></div><div class="px-6 pt-4 pb-2"></div></article><article class="relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src=/previews/112/mlops1-arch.excalidraw_16782172796396726828.svg alt="Scalable Real-Time Credit Card Fraud Detection System" loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class="px-6 py-4"><header><a href=https://github.com/phuchoang2603/realtime-credit-card-fraud-detection target=_blank rel=external class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Scalable Real-Time Credit Card Fraud Detection System
<span class="cursor-default align-top text-xs text-neutral-400 dark:text-neutral-500"><span class=rtl:hidden>&#8599;</span>
<span class=ltr:hidden>&#8598;</span></span></h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-11-06T00:00:00+00:00>6 November 2025</time></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/argo-cd/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Argo-Cd
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/kubernetes/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/github-actions/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Github-Actions
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/terraform/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Terraform
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/grafana/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Grafana
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/prometheus/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Prometheus
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/python/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Python
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/previews/112/tags/cloud/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cloud</span></span></a></div></div><div class="prose dark:prose-invert py-1">This repository contains a complete end-to-end system for real-time credit card fraud detection, including data analysis notebooks, a machine learning API, and infrastructure-as-code for cloud deployment. The system is designed with a modern, observable, and scalable architecture.</div></div><div class="px-6 pt-4 pb-2"></div></article></section></div><script type=text/javascript src=/previews/112/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_posts/on-premise-provison-ansible.md data-oid-likes=likes_posts/on-premise-provison-ansible.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/previews/112/posts/on-premise-provision-terraform/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;On-Premise 101 (Part 4): Automating 12 VMs creation on Proxmox with Terraform
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-11-06T00:00:00+00:00>6 November 2025</time>
</span></span><span class="flex flex-col items-end"></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=phuchoang2603/phuchoang2603.github.io data-repo-id=R_kgDOOUB0Ww data-category=General data-category-id=DIC_kwDOOUB0W84Coz7q data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></footer></article><div id=scroll-to-top class="fixed bottom-24 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Felix Hoang</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/previews/112/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://phuchoang2603.github.io/previews/112/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>